<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LIFT ULTIMATE</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #000;
            color: #fff;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .glass {
            background: #18181b;
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .nav-glass {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        [x-cloak] {
            display: none !important;
        }

        .program-card.selected {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }

        .failed-set {
            border-color: rgba(239, 68, 68, 0.5) !important;
            background: rgba(239, 68, 68, 0.1) !important;
        }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        .cal-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            border-radius: 10px;
            color: #555;
        }

        .cal-today {
            color: white;
            background: #222;
            border: 1px solid #444;
        }

        .cal-active {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
            border: 1px solid rgba(99, 102, 241, 0.4);
            position: relative;
        }

        .cal-active::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 4px;
            height: 4px;
            background: #818cf8;
            border-radius: 50%;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
            }

            50% {
                box-shadow: 0 0 25px rgba(99, 102, 241, 0.6);
            }
        }

        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        .pr-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
        }

        .deload-warning {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.2), rgba(239, 68, 68, 0.2));
            border: 1px solid rgba(251, 146, 60, 0.4);
        }

        .recovery-bar {
            transition: width 0.5s ease-out;
        }

        .achievement-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
        }

        .expand-enter {
            animation: expandIn 0.3s ease-out;
        }

        @keyframes expandIn {
            from {
                opacity: 0;
                max-height: 0;
            }

            to {
                opacity: 1;
                max-height: 500px;
            }
        }

        .rating-star {
            transition: all 0.15s ease;
        }

        .rating-star:hover {
            transform: scale(1.2);
        }

        .set-timeline::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 24px;
            bottom: 0;
            width: 2px;
            background: rgba(255, 255, 255, 0.1);
        }

        .set-timeline:last-child::before {
            display: none;
        }
    </style>

    <script>
        // Database Helpers
        const db = {
            get: (k, d) => {
                try {
                    const val = localStorage.getItem(k);
                    return val ? JSON.parse(val) : d;
                } catch (e) { return d; }
            },
            set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
            del: (k) => localStorage.removeItem(k)
        };

        const utils = {
            now: () => Date.now(),
            fmtTime: (s) => `${Math.floor(s / 60)}:${String(Math.floor(s % 60)).padStart(2, '0')}`,
            fmtSetTime: (ts) => new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            getWeekNum: (d) => { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); return Math.ceil((((d - new Date(Date.UTC(d.getUTCFullYear(), 0, 1))) / 86400000) + 1) / 7); },
            round: (n, u, micro) => { const inc = micro ? (u === 'kg' ? 1.25 : 2.5) : (u === 'kg' ? 2.5 : 5); return Math.round(n / inc) * inc; }
        };

        const ADVANCED_RECOVERY = {
            // Each lift affects multiple muscles with different intensities
            muscleInvolvement: {
                'Bench': { chest: 1.0, frontDelt: 0.6, triceps: 0.5, cns: 0.3 },
                'OHP': { frontDelt: 1.0, triceps: 0.6, upperChest: 0.3, core: 0.2, cns: 0.4 },
                'Squat': { quads: 1.0, glutes: 0.8, lowerBack: 0.6, core: 0.5, cns: 0.7 },
                'Deadlift': { hamstrings: 1.0, glutes: 0.9, lowerBack: 1.0, traps: 0.4, grip: 0.6, cns: 0.9 },
                'Row': { lats: 1.0, biceps: 0.7, rearDelt: 0.5, grip: 0.4, cns: 0.2 }
            },

            // Half-life = hours until fatigue is 50% recovered (exponential decay)
            recoveryHalfLife: {
                chest: 24, frontDelt: 20, triceps: 18, upperChest: 24,
                quads: 36, glutes: 36, lowerBack: 48, core: 24,
                hamstrings: 36, traps: 24, grip: 24,
                lats: 30, biceps: 18, rearDelt: 20,
                cns: 36 // Central nervous system - affects everything
            },

            // User-adjustable recovery modifier
            userModifiers: {
                sleepQuality: 1.0,    // 0.7 (poor) - 1.3 (excellent)
                nutrition: 1.0,       // 0.8 (poor) - 1.2 (great)
                stressLevel: 1.0,     // 0.7 (high stress) - 1.2 (low stress)
                trainingAge: 1.0      // 0.8 (beginner) - 1.2 (advanced)
            },

            /**
             * Calculate fatigue generated by a workout
             * Uses: Volume (sets), Intensity (weight/TM), RPE, and muscle involvement
             */
            calculateWorkoutFatigue(workout, tms) {
                const fatigueMap = {};
                const liftName = workout.details?.t1;
                const involvement = this.muscleInvolvement[liftName] || {};
                const tm = tms[liftName] || 100;

                // Get all completed sets
                const allSets = [
                    ...(workout.setDetails?.t1 || []),
                    ...(workout.setDetails?.t2 || [])
                ].filter(s => s.completed);

                allSets.forEach(set => {
                    // Relative intensity (% of TM)
                    const intensity = set.weight / tm;

                    // Effective reps - heavier weights = more fatigue per rep
                    // RPE modifier if available (from session rating)
                    const rpeModifier = (workout.rpe || 7) / 7;

                    // Fatigue formula: intensityÂ² Ã— reps Ã— rpeModifier
                    // Squared intensity because 90% is WAY harder than 70%
                    const setFatigue = Math.pow(intensity, 2) * set.reps * rpeModifier;

                    // Distribute to muscle groups
                    Object.entries(involvement).forEach(([muscle, factor]) => {
                        fatigueMap[muscle] = (fatigueMap[muscle] || 0) + setFatigue * factor;
                    });
                });

                // Failed sets add extra fatigue (grinding = more stress)
                const failedSets = allSets.filter(s => s.failed).length;
                if (failedSets > 0) {
                    Object.keys(fatigueMap).forEach(m => {
                        fatigueMap[m] *= (1 + failedSets * 0.1);
                    });
                }

                return fatigueMap;
            },

            /**
             * Calculate current fatigue for a muscle using exponential decay
             * Accumulated fatigue from all recent workouts
             */
            getCurrentFatigue(history, muscle, tms) {
                const halfLife = this.recoveryHalfLife[muscle] || 24;
                const modifierAvg = Object.values(this.userModifiers).reduce((a, b) => a + b, 0) / 4;
                const adjustedHalfLife = halfLife / modifierAvg; // Better recovery = faster decay

                let totalFatigue = 0;

                // Only look at last 14 days of workouts
                const recentHistory = history.filter(w =>
                    (Date.now() - w.timestamp) < 14 * 24 * 3600000
                );

                recentHistory.forEach(workout => {
                    const hoursSince = (Date.now() - workout.timestamp) / 3600000;
                    const workoutFatigue = this.calculateWorkoutFatigue(workout, tms);
                    const muscleFatigue = workoutFatigue[muscle] || 0;

                    // Exponential decay: F(t) = Fâ‚€ Ã— (0.5)^(t/halfLife)
                    const remainingFatigue = muscleFatigue * Math.pow(0.5, hoursSince / adjustedHalfLife);
                    totalFatigue += remainingFatigue;
                });

                return totalFatigue;
            },

            /**
             * Get comprehensive recovery status for a muscle group
             */
            getRecoveryStatus(history, muscle, tms) {
                const fatigue = this.getCurrentFatigue(history, muscle, tms);

                // Convert fatigue to percentage (scaled so typical fatigue = ~50%)
                // Max fatigue threshold varies by muscle group
                const maxFatigue = muscle === 'cns' ? 30 : 20;
                const recoveryPct = Math.max(0, Math.min(100, 100 - (fatigue / maxFatigue) * 100));

                // Estimate hours until fully recovered (fatigue < 5%)
                const halfLife = this.recoveryHalfLife[muscle] || 24;
                const hoursToRecover = fatigue > 0 ?
                    halfLife * Math.log2(fatigue / (maxFatigue * 0.05)) : 0;

                return {
                    muscle,
                    fatigue: Math.round(fatigue * 10) / 10,
                    recovery: Math.round(recoveryPct),
                    status: recoveryPct >= 85 ? 'Ready' :
                        recoveryPct >= 60 ? 'Recovering' :
                            recoveryPct >= 30 ? 'Fatigued' : 'Overtrained',
                    hoursToReady: Math.max(0, Math.round(hoursToRecover)),
                    recommendation: this.getRecommendation(recoveryPct, muscle)
                };
            },

            getRecommendation(pct, muscle) {
                if (pct >= 85) return 'Good to train heavy';
                if (pct >= 60) return 'Light/moderate OK';
                if (pct >= 30) return 'Active recovery only';
                return 'Rest recommended';
            },

            /**
             * Get aggregated view for dashboard display
             */
            getMuscleGroupRecovery(history, tms) {
                // Group muscles into display categories
                const groups = {
                    'Push': ['chest', 'frontDelt', 'triceps'],
                    'Pull': ['lats', 'biceps', 'rearDelt', 'traps'],
                    'Legs': ['quads', 'hamstrings', 'glutes'],
                    'Core/Back': ['lowerBack', 'core'],
                    'CNS': ['cns']
                };

                return Object.entries(groups).map(([name, muscles]) => {
                    const recoveries = muscles.map(m =>
                        this.getRecoveryStatus(history, m, tms).recovery
                    );
                    const avgRecovery = recoveries.reduce((a, b) => a + b, 0) / recoveries.length;
                    const minRecovery = Math.min(...recoveries);

                    return {
                        name,
                        recovery: Math.round(avgRecovery),
                        weakest: Math.round(minRecovery),
                        status: minRecovery >= 85 ? 'Ready' :
                            minRecovery >= 60 ? 'Recovering' : 'Fatigued'
                    };
                });
            }
        };

        const DELOAD_SYSTEM = {
            levels: [[42, 25, '6+ weeks off'], [28, 20, '4 weeks off'], [14, 10, '2 weeks off']],
            evaluate(d) { const m = this.levels.find(l => d >= l[0]); return m ? { needed: true, percentage: m[1], reason: m[2], protocol: 'volume_reduction' } : { needed: false }; }
        };

        const SCHEMES = {
            nsuns: {
                t1_volume: [[0.65, 8], [0.75, 6], [0.85, 4], [0.85, 4], [0.85, 4], [0.80, 5], [0.75, 6], [0.70, 7], [0.65, 8, '+']],
                t1_heavy: [[0.75, 5], [0.85, 3], [0.95, 1, '+'], [0.90, 3], [0.85, 3], [0.80, 3], [0.75, 5], [0.70, 5], [0.65, 5, '+']],
                t1_deadlift: [[0.75, 5], [0.85, 3], [0.95, 1, '+'], [0.90, 3], [0.85, 3], [0.80, 3], [0.75, 3], [0.70, 3], [0.65, 3]],
                t2_standard: [[0.50, 5], [0.60, 6], [0.70, 7], [0.70, 4], [0.70, 4], [0.70, 4], [0.70, 4], [0.70, 4]]
            },
            stronglifts: { standard: [[1.0, 5], [1.0, 5], [1.0, 5], [1.0, 5], [1.0, 5, '+']], deadlift: [[1.0, 5, '+']] },
            phul: { power: [[0.85, 5], [0.85, 5], [0.85, 5]], hyper: [[0.65, 10], [0.65, 10], [0.65, 10]], volume: [[0.60, 12], [0.60, 12], [0.60, 12]] },
            ppl: { main_5x5: [[0.85, 5], [0.85, 5], [0.85, 5], [0.85, 5], [0.85, 5, '+']], main_1x5: [[0.90, 5, '+']], secondary: [[0.70, 10], [0.70, 10], [0.70, 10]] },
            gzclp: { t1: { stage1: { sets: 5, reps: 3, amrap: true }, stage2: { sets: 6, reps: 2, amrap: true }, stage3: { sets: 10, reps: 1, amrap: true } }, t2: { stage1: { sets: 3, reps: 10 }, stage2: { sets: 3, reps: 8 }, stage3: { sets: 3, reps: 6 } } },
            '531': { week1: [[0.65, 5], [0.75, 5], [0.85, 5, '+']], week2: [[0.70, 3], [0.80, 3], [0.90, 3, '+']], week3: [[0.75, 5], [0.85, 3], [0.95, 1, '+']], deload: [[0.40, 5], [0.50, 5], [0.60, 5]], bbb: [[0.50, 10], [0.50, 10], [0.50, 10], [0.50, 10], [0.50, 10]] }
        };

        const PROGRESSION_ENGINE = {
            evaluateAmrap(performed, target, unit) {
                const diff = performed - target, base = unit === 'kg' ? 2.5 : 5;
                return diff >= 5 ? base * 2 : diff >= 0 ? base : 0;
            },
            gzclpFail(currentStage) { return currentStage >= 3 ? { action: 'reset', newStage: 1 } : { action: 'advance', newStage: currentStage + 1 }; }
        };

        const PROGRAMS = {
            nsuns: { name: 'nSuns LP', daysPerWeek: 5, description: 'High volume, auto-regulated.', progressionDesc: 'AMRAP-based TM increase', progression: { type: 'amrap' }, days: [{ title: 'Bench Vol', t1: 'Bench', t2: 'OHP', s: 't1_volume', t2s: 't2_standard', focus: 'Chest & Shoulders', acc: [{ name: 'Row', sets: 4, reps: '8-12' }] }, { title: 'Squat Heavy', t1: 'Squat', t2: 'Deadlift', s: 't1_heavy', t2s: 't2_standard', focus: 'Lower Body Power', acc: [{ name: 'Leg Acc', sets: 4, reps: '10-12' }] }, { title: 'OHP Heavy', t1: 'OHP', t2: 'Bench', s: 't1_heavy', t2s: 't2_standard', focus: 'Shoulder Strength', acc: [{ name: 'Pullups', sets: 4, reps: '6-10' }] }, { title: 'Deadlift Heavy', t1: 'Deadlift', t2: 'Squat', s: 't1_deadlift', t2s: 't2_standard', focus: 'Posterior Chain', acc: [{ name: 'Abs', sets: 4, reps: '15' }] }, { title: 'Bench Heavy', t1: 'Bench', t2: 'Bench', s: 't1_heavy', t2s: 't2_standard', focus: 'Bench Max Effort', acc: [{ name: 'Arms', sets: 4, reps: '10-15' }] }] },
            ppl: { name: 'Classic PPL', daysPerWeek: 6, description: 'Push Pull Legs. Aesthetics focus.', progressionDesc: 'Linear + AMRAP', progression: { type: 'linear' }, days: [{ title: 'Push A', t1: 'Bench', t2: 'OHP', s: 'main_5x5', t2s: 'secondary', focus: 'Chest/Shoulders/Tri', acc: [{ name: 'Triceps', sets: 3, reps: '10-12' }, { name: 'Lateral Raise', sets: 3, reps: '15' }] }, { title: 'Pull A', t1: 'Deadlift', t2: 'Row', s: 'main_1x5', t2s: 'secondary', focus: 'Back/Biceps', acc: [{ name: 'Biceps', sets: 3, reps: '10-12' }, { name: 'Face Pulls', sets: 3, reps: '15' }] }, { title: 'Legs A', t1: 'Squat', t2: 'Deadlift', s: 'main_5x5', t2s: 'secondary', focus: 'Quads/Hams', acc: [{ name: 'Calves', sets: 3, reps: '15' }, { name: 'Leg Curl', sets: 3, reps: '12' }] }, { title: 'Push B', t1: 'OHP', t2: 'Bench', s: 'main_5x5', t2s: 'secondary', focus: 'Shoulders/Chest/Tri', acc: [{ name: 'Triceps', sets: 3, reps: '10-12' }, { name: 'Incline DB', sets: 3, reps: '12' }] }, { title: 'Pull B', t1: 'Row', t2: 'Deadlift', s: 'main_5x5', t2s: 'volume', focus: 'Back/Biceps', acc: [{ name: 'Hammer Curl', sets: 3, reps: '10-12' }, { name: 'Lat PD', sets: 3, reps: '12' }] }, { title: 'Legs B', t1: 'Squat', t2: 'Deadlift', s: 'main_5x5', t2s: 'secondary', focus: 'Quads/Hams', acc: [{ name: 'Lunges', sets: 3, reps: '10' }, { name: 'Leg Ext', sets: 3, reps: '15' }] }] },
            phul: { name: 'PHUL', daysPerWeek: 4, description: 'Power Hypertrophy Upper Lower.', progressionDesc: 'Linear Periodization', progression: { type: 'linear' }, days: [{ title: 'Upper Power', t1: 'Bench', t2: 'Row', s: 'power', t2s: 'power', focus: 'Upper Body Str', acc: [{ name: 'OHP', sets: 3, reps: '8' }, { name: 'Skullcrushers', sets: 3, reps: '8' }] }, { title: 'Lower Power', t1: 'Squat', t2: 'Deadlift', s: 'power', t2s: 'power', focus: 'Lower Body Str', acc: [{ name: 'Leg Press', sets: 3, reps: '10' }, { name: 'Calves', sets: 4, reps: '10' }] }, { title: 'Upper Hyper', t1: 'OHP', t2: 'Bench', s: 'hyper', t2s: 'hyper', focus: 'Upper Body Size', acc: [{ name: 'Row', sets: 3, reps: '10' }, { name: 'Bicep Curl', sets: 3, reps: '12' }] }, { title: 'Lower Hyper', t1: 'Deadlift', t2: 'Squat', s: 'hyper', t2s: 'hyper', focus: 'Lower Body Size', acc: [{ name: 'Lunges', sets: 3, reps: '12' }, { name: 'Leg Curl', sets: 3, reps: '12' }] }] },
            stronglifts: { name: 'StrongLifts 5x5', daysPerWeek: 3, description: 'Classic beginner strength.', progressionDesc: '+5lbs/2.5kg per workout', progression: { type: 'linear', perWorkout: true }, days: [{ title: 'Workout A', t1: 'Squat', t2: 'Bench', s: 'standard', t2s: 'standard', focus: 'Full Body A', acc: [{ name: 'Row', sets: 5, reps: '5' }] }, { title: 'Workout B', t1: 'Squat', t2: 'OHP', s: 'standard', t2s: 'standard', focus: 'Full Body B', acc: [{ name: 'Deadlift', sets: 1, reps: '5' }] }] },
            gzclp: { name: 'GZCLP', daysPerWeek: 4, description: 'Tiered intermediate LP.', progressionDesc: 'Stage progression on fail', progression: { type: 'gzclp' }, days: [{ title: 'Day 1', t1: 'Squat', t2: 'Bench', s: 'gzclp_t1', t2s: 'gzclp_t2', focus: 'Squat Focus', acc: [{ name: 'Lat PD', sets: 3, reps: '15+' }] }, { title: 'Day 2', t1: 'OHP', t2: 'Deadlift', s: 'gzclp_t1', t2s: 'gzclp_t2', focus: 'Press Focus', acc: [{ name: 'Row', sets: 3, reps: '15+' }] }, { title: 'Day 3', t1: 'Bench', t2: 'Squat', s: 'gzclp_t1', t2s: 'gzclp_t2', focus: 'Bench Focus', acc: [{ name: 'Tri', sets: 3, reps: '15+' }] }, { title: 'Day 4', t1: 'Deadlift', t2: 'OHP', s: 'gzclp_t1', t2s: 'gzclp_t2', focus: 'Deadlift Focus', acc: [{ name: 'Bi', sets: 3, reps: '15+' }] }] },
            '531': { name: '5/3/1 BBB', daysPerWeek: 4, description: '3-week cycle + Deload.', progressionDesc: 'Weekly % variation', progression: { type: '531', perCycle: 4 }, days: [{ title: 'OHP Day', t1: 'OHP', t2: 'OHP', s: '531', t2s: 'bbb', focus: 'Overhead Press', acc: [{ name: 'Chins', sets: 5, reps: '10' }] }, { title: 'Deadlift Day', t1: 'Deadlift', t2: 'Deadlift', s: '531', t2s: 'bbb', focus: 'Deadlift Volume', acc: [{ name: 'Abs', sets: 5, reps: '10' }] }, { title: 'Bench Day', t1: 'Bench', t2: 'Bench', s: '531', t2s: 'bbb', focus: 'Bench Press', acc: [{ name: 'Row', sets: 5, reps: '10' }] }, { title: 'Squat Day', t1: 'Squat', t2: 'Squat', s: '531', t2s: 'bbb', focus: 'Squat Volume', acc: [{ name: 'Legs', sets: 5, reps: '10' }] }] }
        };

        const ACHIEVEMENTS = [
            { id: 'first_workout', title: 'First Steps', description: 'Complete your first workout', icon: 'ðŸŽ¯', check: h => h.length >= 1 },
            { id: 'week_streak', title: 'Week Warrior', description: 'Complete 7 workouts', icon: 'ðŸ”¥', check: h => h.length >= 7 },
            { id: 'month_streak', title: 'Monthly Master', description: 'Complete 30 workouts', icon: 'ðŸ’ª', check: h => h.length >= 30 },
            { id: 'century', title: 'Century Club', description: 'Complete 100 workouts', icon: 'ðŸ†', check: h => h.length >= 100 },
            { id: 'first_pr', title: 'PR Machine', description: 'Get your first TM increase', icon: 'ðŸ“ˆ', check: h => h.some(w => w.pr) },
            { id: 'five_prs', title: 'Gains Train', description: 'Achieve 5 TM increases', icon: 'ðŸš‚', check: h => h.filter(w => w.pr).length >= 5 },
            { id: 'volume_king', title: 'Volume King', description: 'Log 100,000 lbs total volume', icon: 'ðŸ‘‘', check: h => h.reduce((a, w) => a + (w.totalVolume || 0), 0) >= 100000 },
            { id: 'comeback', title: 'Comeback Kid', description: 'Return after 14+ days off', icon: 'ðŸ’«', check: h => h.length >= 2 },
            { id: 'five_star', title: 'Five Star', description: 'Rate a workout 5 stars', icon: 'âœ¨', check: h => h.some(w => w.rating === 5) }
        ];

        function app() {
            return {
                view: 'dashboard', PROGRAMS, ACHIEVEMENTS,
                tms: { Bench: 0, Squat: 0, Deadlift: 0, OHP: 0, Row: 0 },
                programState: {}, prs: {}, history: [], bwLog: [], achievements: [],
                prefs: { weightUnit: 'lbs', program: 'nsuns', restT1: 180, restT2: 120, restT3: 60, timerSound: true, vibration: true, autoStartTimer: true, showPreviousWorkout: true, autoDeload: true, barWeight: 45, microplates: false },
                setup: {}, currentDayIdx: 0, previewDayIdx: 0, currentWeek: 1, streak: 0,
                modals: { resume: false, weight: false, onerm: false, deload: false, rating: false, achievement: false, workoutDetail: false, info: false },
                session: { t1: {}, t2: {}, acc: [], completedAcc: {}, notes: '' },
                savedSession: null, tempBodyWeight: null, timer: { active: false, start: null, dur: 0, rem: 0, pct: 0 },
                showWarmups: false, calc: { w: 0, r: 0 }, plate: { open: false, w: 0, plates: [] },
                chartLift: 'Bench', cal: { monthName: '', days: [], offset: 0 },
                plateColors: { 55: 'bg-red-700 text-white', 45: 'bg-blue-600 text-white', 35: 'bg-yellow-500 text-black', 25: 'bg-green-500 text-black', 20: 'bg-blue-600 text-white', 15: 'bg-yellow-500 text-black', 10: 'bg-white text-black', 5: 'bg-white text-black', 2.5: 'bg-red-400 text-white', 1.25: 'bg-gray-400 text-black' },
                sessionTimerStr: '0:00', deloadInfo: { reason: '', percentage: 0, protocol: '' }, sessionRating: 0, sessionNotes: '', sessionRPE: 7.0, currentAchievement: null, selectedLog: null, historyFilter: 'all', previousWorkout: null,
                isEditingLog: false, // NEW STATE FOR EDITING

                init() {
                    const d = db.get('nsuns_ultimate', null);
                    const p = db.get('lift_preferences', {});
                    this.prefs = { ...this.prefs, ...p };
                    ['restT1', 'restT2', 'restT3'].forEach(k => this.prefs[k] = +this.prefs[k]);
                    this.bwLog = db.get('lift_bodyweight', []);
                    this.savedSession = db.get('lift_active_session', null);
                    this.achievements = db.get('lift_achievements', []);
                    this.prs = db.get('lift_prs', {});
                    if (!this.prefs.barWeight) this.prefs.barWeight = this.prefs.weightUnit === 'kg' ? 20 : 45;

                    if (d) {
                        Object.assign(this, { tms: d.tms, history: d.history || [], currentDayIdx: d.idx || 0, currentWeek: d.week || 1, streak: d.streak || 0, programState: d.programState || {} });
                        this.previewDayIdx = this.currentDayIdx;
                        this.getLifts().forEach(l => { if (!this.programState[l]) this.programState[l] = { stage: 1 }; });
                        this.history.forEach(h => { if (!h.timestamp) h.timestamp = new Date(h.date).getTime(); });
                        if (this.savedSession && this.savedSession.t1) this.modals.resume = true;
                        this.$nextTick(() => { this.renderMainChart(); this.renderVolumeChart(); this.buildCalendar(); this.checkAchievements(); });
                    } else this.view = 'setup';

                    setInterval(() => {
                        const now = utils.now();
                        if (this.session.start) this.sessionTimerStr = utils.fmtTime((now - this.session.start) / 1000);
                        if (this.timer.active && this.timer.start) {
                            this.timer.rem = Math.max(0, this.timer.dur - Math.floor((now - this.timer.start) / 1000));
                            this.timer.pct = this.timer.rem / this.timer.dur;
                            if (this.timer.rem <= 0) {
                                this.stopTimer();
                                if (this.prefs.timerSound) this.beep();
                                if (this.prefs.vibration && navigator.vibrate) navigator.vibrate([200, 100, 200]);
                            }
                        }
                    }, 1000);
                },

                navigate(v) {
                    this.view = v;
                    if (v === 'calendar') this.buildCalendar();
                    else if (v === 'preferences') this.$nextTick(() => this.renderBWChart());
                    else if (v === 'dashboard') this.$nextTick(() => { this.renderMainChart(); this.renderVolumeChart(); });
                },
                getLifts: () => ['Bench', 'Squat', 'Deadlift', 'OHP', 'Row'],
                getWorkout() { const p = PROGRAMS[this.prefs.program]; return p.days[this.previewDayIdx % p.days.length]; },
                isDeloadWeek() { return this.prefs.program === '531' && this.currentWeek % 4 === 0; },

                changePreviewDay(dir) {
                    const len = PROGRAMS[this.prefs.program].days.length;
                    this.previewDayIdx = (this.previewDayIdx + dir + len) % len;
                },

                getSets(schemeName, liftName, tm, tier) {
                    const { program, weightUnit, microplates } = this.prefs, rnd = w => utils.round(w, weightUnit, microplates);

                    if (program === 'gzclp') {
                        const stage = this.programState[liftName]?.stage || 1, s = SCHEMES.gzclp[tier][`stage${stage}`], pct = tier === 't1' ? 0.85 : 0.65;
                        return Array(s.sets).fill(0).map((_, i) => ({ weight: rnd(tm * pct), reps: s.reps, amrap: i === s.sets - 1 && s.amrap ? '+' : false, completed: false, failed: false }));
                    }
                    if (program === '531' && tier === 't1') {
                        const wk = this.currentWeek % 4 || 4, s = SCHEMES['531'][wk === 4 ? 'deload' : `week${wk}`];
                        return s.map(x => ({ weight: rnd(tm * x[0]), reps: x[1], amrap: x[2] === '+', completed: false, failed: false }));
                    }
                    const scheme = (SCHEMES[program] || SCHEMES.nsuns)[schemeName] || SCHEMES.nsuns.t1_volume;
                    return scheme.map(x => ({ weight: rnd(tm * x[0]), reps: x[1], amrap: x[2] === '+', completed: false, failed: false }));
                },

                getBarOptions() { return this.prefs.weightUnit === 'kg' ? [{ weight: 20, name: 'Olympic' }, { weight: 15, name: 'Women' }, { weight: 10, name: 'Training' }, { weight: 7, name: 'Curl' }] : [{ weight: 45, name: 'Olympic' }, { weight: 35, name: 'Women' }, { weight: 25, name: 'Training' }, { weight: 15, name: 'Curl' }]; },
                getDaysOff() { const h = this.history; return h.length ? Math.floor((Date.now() - new Date(h[h.length - 1].timestamp || h[h.length - 1].date)) / 86400000) : 0; },

                checkDeloadAndStart() {
                    const check = DELOAD_SYSTEM.evaluate(this.getDaysOff());
                    if (this.prefs.autoDeload && check.needed) { this.deloadInfo = check; this.modals.deload = true; }
                    else this.modals.weight = true;
                },
                applyDeload() { Object.keys(this.tms).forEach(k => this.tms[k] = Math.round(this.tms[k] * (1 - this.deloadInfo.percentage / 100))); this.saveData(); this.modals.deload = false; this.modals.weight = true; },

                startSession(custom) {
                    const d = custom || this.getWorkout();
                    this.session = {
                        title: d.title, start: utils.now(), acc: JSON.parse(JSON.stringify(d.acc || [])), completedAcc: {}, notes: '',
                        dayIdx: custom ? null : this.previewDayIdx,
                        t1: { name: d.t1, sets: this.getSets(d.s, d.t1, this.tms[d.t1], 't1') },
                        t2: { name: d.t2, sets: this.getSets(d.t2s, d.t2, this.tms[d.t2], 't2') }
                    };
                    if (this.prefs.showPreviousWorkout) {
                        const prev = this.history.slice().reverse().find(h => h.details?.t1 === d.t1);
                        this.previousWorkout = prev ? { date: prev.date, duration: prev.duration, topSet: prev.details?.weight || '-', amrapResult: prev.setDetails?.t1?.find(s => s.amrap)?.performed || '-' } : null;
                    }
                    this.saveSession(); this.view = 'workout';
                },

                completeSet(set, tier, idx) {
                    if (!set.performed && set.amrap) return;
                    set.completed = set.failed || !set.completed;
                    set.completedAt = set.completed ? utils.now() : null;
                    if (set.completed && this.prefs.autoStartTimer) this.startTimer(+this.prefs[tier === 't1' ? 'restT1' : 'restT2'] + (set.failed ? 60 : 0));
                    this.saveSession();
                },

                finishSession() { this.sessionRating = 0; this.sessionNotes = this.session.notes || ''; this.sessionRPE = 7; this.stopTimer(); this.modals.rating = true; },

                saveSessionRating() {
                    const { t1, t2 } = this.session, lift = t1.name, prSet = t1.sets.find(s => s.amrap), prog = this.prefs.program, unit = this.prefs.weightUnit;
                    let inc = 0, baseInc = unit === 'kg' ? 2.5 : 5;

                    if (prog === 'gzclp') {
                        if (t1.sets.some(s => s.failed)) {
                            const res = PROGRESSION_ENGINE.gzclpFail(this.programState[lift].stage);
                            if (res.action === 'reset') { this.programState[lift].stage = 1; this.tms[lift] = Math.round(this.tms[lift] * 0.85); }
                            else this.programState[lift].stage = res.newStage;
                        } else { inc = baseInc; this.tms[lift] += inc; }
                    } else if (prSet && prSet.performed > prSet.reps) {
                        inc = PROGRESSION_ENGINE.evaluateAmrap(prSet.performed, prSet.reps, unit);
                        this.tms[lift] += inc;
                    } else if (PROGRAMS[prog].progression.type === 'linear' && !t1.sets.some(s => s.failed)) {
                        inc = baseInc; this.tms[lift] += inc;
                    }

                    if (inc > 0) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });

                    const e1rm = prSet ? Math.round(prSet.weight * (1 + (prSet.performed || prSet.reps) / 30)) : 0;
                    if (e1rm > (this.prs[lift]?.weight || 0)) { this.prs[lift] = { weight: e1rm, date: new Date().toLocaleDateString() }; db.set('lift_prs', this.prs); }

                    const allSets = [...t1.sets, ...t2.sets];
                    this.history.push({
                        date: new Date().toLocaleDateString(), timestamp: utils.now(), title: this.session.title, increase: inc, pr: inc > 0,
                        duration: Math.round((utils.now() - this.session.start) / 60000), rating: this.sessionRating, rpe: this.sessionRPE, notes: this.sessionNotes,
                        totalVolume: allSets.reduce((a, s) => s.completed ? a + (s.weight * (s.performed || s.reps)) : a, 0),
                        totalSets: allSets.length, completedSets: allSets.filter(s => s.completed).length,
                        details: { t1: lift, weight: prSet?.weight, est1rm: e1rm },
                        setDetails: { t1: t1.sets, t2Name: t2.name, t2: t2.sets, accessories: this.session.acc.map(a => ({ name: a.name, total: a.sets, completed: Object.keys(this.session.completedAcc).filter(k => k.startsWith(a.name)).length })) }
                    });

                    if (this.session.dayIdx !== null) {
                        const pLen = PROGRAMS[prog].days.length;
                        this.currentDayIdx = (this.session.dayIdx + 1) % pLen;
                        if (this.currentDayIdx === 0) this.currentWeek++;
                        this.previewDayIdx = this.currentDayIdx;
                    }

                    this.streak++;

                    this.savedSession = null;
                    db.del('lift_active_session');
                    this.session = {};
                    this.modals.rating = false;

                    this.saveData(); this.checkAchievements(); this.view = 'dashboard'; this.buildCalendar();
                    this.$nextTick(() => { this.renderMainChart(); this.renderVolumeChart(); });
                },

                generateWarmups() { const w = this.session.t1.sets[0].weight; return [{ w: 20, r: 10 }, { w: w * 0.4, r: 5 }, { w: w * 0.6, r: 3 }, { w: w * 0.8, r: 2 }].filter(x => x.w > 20); },
                renderMainChart() { const d = this.history.filter(h => h.details?.t1 === this.chartLift); this.renderChart('mainChart', d.map(h => h.date), d.map(h => h.details.est1rm), '#6366f1'); },
                renderBWChart() { const d = this.bwLog.slice(-30); this.renderChart('bodyWeightChart', d.map(x => new Date(x.date).toLocaleDateString()), d.map(x => x.weight), '#3b82f6'); },
                renderVolumeChart() {
                    const v = {}; this.history.slice(-20).forEach(h => { const k = `W${utils.getWeekNum(new Date(h.timestamp))}`; v[k] = (v[k] || 0) + (h.totalVolume || 0); });
                    this.renderChart('volumeChart', Object.keys(v), Object.values(v), '#10b981', 'bar');
                },
                renderChart(id, l, d, c, t = 'line') {
                    const ctx = document.getElementById(id); if (!ctx) return; if (ctx.c) ctx.c.destroy();
                    ctx.c = new Chart(ctx, { type: t, data: { labels: l, datasets: [{ data: d, borderColor: c, backgroundColor: t === 'line' ? (x => { const g = x.chart.ctx.createLinearGradient(0, 0, 0, 160); g.addColorStop(0, c + '80'); g.addColorStop(1, c + '00'); return g }) : c + '80', tension: 0.3, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false }, scales: { x: { display: false }, y: { grid: { color: '#ffffff0d' }, ticks: { color: '#666' } } } } });
                },

                saveSession() {
                    if (!this.session || !this.session.start) return;
                    db.set('lift_active_session', this.session);
                },
                saveData() { db.set('nsuns_ultimate', { tms: this.tms, history: this.history, idx: this.currentDayIdx, week: this.currentWeek, streak: this.streak, programState: this.programState }); },
                savePrefs() { db.set('lift_preferences', this.prefs); },

                openPlateCalc(w) {
                    this.plate = { open: true, w, plates: [] }; let rem = (w - this.prefs.barWeight) / 2; if (rem <= 0) return;
                    (this.prefs.weightUnit === 'kg' ? [25, 20, 15, 10, 5, 2.5, 1.25] : [45, 35, 25, 10, 5, 2.5]).forEach(p => { while (rem >= p) { this.plate.plates.push(p); rem -= p; } });
                },

                buildCalendar() {
                    const now = new Date(); now.setMonth(now.getMonth() + this.cal.offset);
                    this.cal.monthName = now.toLocaleString('default', { month: 'long', year: 'numeric' });
                    const y = now.getFullYear(), m = now.getMonth(), days = new Date(y, m + 1, 0).getDate(), first = new Date(y, m, 1).getDay();
                    this.cal.days = [...Array(first).fill({}), ...[...Array(days).keys()].map(i => ({ num: i + 1, isToday: new Date().getDate() === i + 1 && !this.cal.offset, hasLog: this.history.some(h => { const d = new Date(h.timestamp); return d.getDate() === i + 1 && d.getMonth() === m; }) }))];
                },

                beep() { if (!window.ac) window.ac = new (window.AudioContext || window.webkitAudioContext)(); const o = ac.createOscillator(), g = ac.createGain(); o.connect(g); g.connect(ac.destination); o.frequency.value = 800; g.gain.exponentialRampToValueAtTime(0.00001, ac.currentTime + 0.5); o.start(); o.stop(ac.currentTime + 0.5); },
                checkAchievements() { ACHIEVEMENTS.forEach(a => { if (!this.achievements.includes(a.id) && a.check(this.history)) { this.achievements.push(a.id); this.currentAchievement = a; this.modals.achievement = true; db.set('lift_achievements', this.achievements); } }); },
                hasAchievement(id) { return this.achievements.includes(id); },

                getMuscleRecovery() {
    return ADVANCED_RECOVERY.getMuscleGroupRecovery(this.history, this.tms);
},
                getDetailedRecovery(muscle) {
                    return ADVANCED_RECOVERY.getRecoveryStatus(this.history, muscle, this.tms);
                },
                updateRecoveryModifiers() {
                    ADVANCED_RECOVERY.userModifiers = {
                        sleepQuality: this.prefs.sleepQuality || 1.0,
                        nutrition: this.prefs.nutritionQuality || 1.0,
                        stressLevel: this.prefs.stressLevel || 1.0,
                        trainingAge: this.prefs.trainingAge || 1.0
                    };
                },

                finishSetup() { if (Object.values(this.setup).some(v => v > 0)) { Object.keys(this.setup).forEach(k => this.tms[k] = utils.round(this.setup[k] * 0.9, this.prefs.weightUnit)); this.saveData(); this.savePrefs(); this.view = 'dashboard'; } },
                resumeWorkout() { this.session = this.savedSession; this.modals.resume = false; this.view = 'workout'; },
                discardWorkout() { this.savedSession = null; db.del('lift_active_session'); this.modals.resume = false; },
                finishSavedSession() { this.session = this.savedSession; this.modals.resume = false; this.finishSession(); },
                cancelWorkout() { if (confirm('Save progress?')) { this.saveSession(); this.view = 'dashboard'; } },
                logBodyWeight() { if (this.tempBodyWeight) { this.bwLog.push({ date: utils.now(), weight: this.tempBodyWeight }); db.set('lift_bodyweight', this.bwLog); } this.modals.weight = false; this.startSession(); },
                getBW(t) { const w = this.bwLog.map(x => x.weight); return !w.length ? '-' : t === 'last' ? w[w.length - 1] : t === 'min' ? Math.min(...w) : Math.max(...w); },
                startTimer(s) { this.timer = { active: true, start: utils.now(), dur: +s, rem: +s, pct: 1 }; },
                stopTimer() { this.timer.active = false; },
                adjustTimer(s) { if (this.timer.active) this.timer.dur = Math.max(0, this.timer.dur + s); },
                formatTime: utils.fmtTime,
                formatSetTime: utils.fmtSetTime,
                formatVolume() { const v = this.history.reduce((a, h) => a + (h.totalVolume || 0), 0); return v > 1e6 ? (v / 1e6).toFixed(1) + 'M' : v > 1e3 ? (v / 1e3).toFixed(0) + 'K' : v; },
                formatVolumeShort(v) { return v ? v > 1e3 ? (v / 1e3).toFixed(1) + 'k' : v : '-'; },
                getAvgDuration() { const l = this.history.filter(h => h.duration); return l.length ? Math.round(l.reduce((a, b) => a + b.duration, 0) / l.length) : '-'; },
                getTotalPRs() { return this.history.filter(h => h.pr).length; },
                getFailedT1Count() { return this.session.t1?.sets?.filter(s => s.failed).length || 0; },
                getSessionProgress() { const t = this.session.t1?.sets, t2 = this.session.t2?.sets; return t ? Math.round((t.filter(s => s.completed).length + (t2 ? t2.filter(s => s.completed).length : 0)) / (t.length + (t2 ? t2.length : 0)) * 100) : 0; },
                getEstimatedDuration() { return 60; },
                getTimeAgo(ts) { const d = Math.floor((utils.now() - ts) / 60000); return d < 60 ? d + 'm ago' : Math.floor(d / 60) + 'h ago'; },
                toggleAcc(n, i) { const k = `${n}-${i}`; this.session.completedAcc[k] = !this.session.completedAcc[k]; this.saveSession(); if (this.session.completedAcc[k] && this.prefs.autoStartTimer) this.startTimer(+this.prefs.restT3); },
                isAccDone(n, i) { return !!this.session.completedAcc[`${n}-${i}`]; },
                addSet() { this.session.t1.sets.push({ ...this.session.t1.sets[this.session.t1.sets.length - 1], completed: false, failed: false }); },
                changeMonth(d) { this.cal.offset += d; this.buildCalendar(); },
                exportData() { const b = new Blob([JSON.stringify({ nsuns_ultimate: db.get('nsuns_ultimate'), lift_preferences: this.prefs })], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'lift_backup.json'; a.click(); },
                importData(e) { const r = new FileReader(); r.onload = ev => { try { const d = JSON.parse(ev.target.result); db.set('nsuns_ultimate', d.nsuns_ultimate); location.reload(); } catch (x) { alert('Error'); } }; r.readAsText(e.target.files[0]); },
                resetAll() { if (confirm('Reset all?')) { localStorage.clear(); location.reload(); } },
                getFilteredHistory() { const l = this.history.slice().reverse(); return this.historyFilter !== 'all' ? l.filter(h => h.details?.t1 === this.historyFilter).slice(0, 50) : l.slice(0, 50); },
                showDayLogs(day) { const n = new Date(); n.setMonth(n.getMonth() + this.cal.offset); const l = this.history.find(h => h.date === new Date(n.getFullYear(), n.getMonth(), day.num).toLocaleDateString()); if (l) this.openWorkoutDetail(l); },
                openWorkoutDetail(l) { this.selectedLog = l; this.isEditingLog = false; this.modals.workoutDetail = true; },
                selectProgram(k) { this.prefs.program = k; this.savePrefs(); this.previewDayIdx = 0; this.currentDayIdx = 0; },

                // NEW: DELETE LOG
                deleteLog() {
                    if (confirm('Delete this workout permanently?')) {
                        this.history = this.history.filter(h => h.timestamp !== this.selectedLog.timestamp);
                        this.saveData();
                        this.modals.workoutDetail = false;
                        this.buildCalendar();
                        this.$nextTick(() => { this.renderMainChart(); this.renderVolumeChart(); });
                    }
                },

                // NEW: SAVE EDITS
                saveLogEdits() {
                    const idx = this.history.findIndex(h => h.timestamp === this.selectedLog.timestamp);
                    if (idx !== -1) {
                        // Update the history array with modified values from selectedLog
                        this.history[idx].notes = this.selectedLog.notes;
                        this.history[idx].duration = parseInt(this.selectedLog.duration) || 0;
                        this.history[idx].rating = parseInt(this.selectedLog.rating) || 0;
                        this.saveData();
                        this.isEditingLog = false;
                        this.$nextTick(() => { this.renderMainChart(); this.renderVolumeChart(); });
                    }
                }
            }
        }
    </script>
</head>

<body x-data="app()" x-init="init()" class="antialiased h-screen overflow-hidden text-slate-200">

    <!-- RESUME MODAL -->
    <div x-show="modals.resume"
        class="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-black/90 backdrop-blur-md" x-cloak
        x-transition>
        <div class="bg-[#1A1A1E] border border-white/10 rounded-3xl p-6 w-full max-w-sm shadow-2xl relative">
            <div class="text-center mb-6">
                <h3 class="text-xl font-bold text-white">Workout In Progress</h3>
                <p class="text-sm text-slate-400 mt-1" x-text="'Session: ' + (savedSession?.title || '')"></p>
                <p class="text-xs text-slate-500 mt-1"
                    x-text="savedSession?.start ? 'Started ' + getTimeAgo(savedSession.start) : ''"></p>
            </div>
            <div class="space-y-3">
                <button @click="resumeWorkout()"
                    class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-transform">Resume</button>
                <button @click="finishSavedSession()"
                    class="w-full bg-green-600/20 text-green-400 font-bold py-3.5 rounded-xl border border-green-500/30 active:scale-95">Finish
                    & Save</button>
                <button @click="discardWorkout()"
                    class="w-full bg-red-600/10 text-red-400 font-bold py-3.5 rounded-xl border border-red-500/20 active:scale-95">Discard</button>
            </div>
        </div>
    </div>

    <!-- DELOAD WARNING MODAL -->
    <div x-show="modals.deload"
        class="fixed inset-0 z-[180] flex items-center justify-center p-6 bg-black/90 backdrop-blur-md" x-cloak
        x-transition>
        <div class="bg-[#1A1A1E] border border-orange-500/30 rounded-3xl p-6 w-full max-w-sm shadow-2xl relative">
            <div class="text-center mb-6">
                <div class="w-16 h-16 mx-auto mb-4 bg-orange-500/20 rounded-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-white">Deload Recommended</h3>
                <p class="text-sm text-slate-400 mt-2" x-text="deloadInfo.reason"></p>
                <p class="text-xs text-slate-500 mt-1"
                    x-text="'Recommended protocol: ' + deloadInfo.protocol.replace('_', ' ')"></p>
            </div>
            <div class="space-y-3">
                <button @click="applyDeload()"
                    class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-transform">Apply
                    Deload</button>
                <button @click="modals.deload=false; modals.weight=true"
                    class="w-full bg-[#333] text-slate-300 font-bold py-3.5 rounded-xl active:scale-95">Skip (Not
                    Recommended)</button>
            </div>
        </div>
    </div>

    <!-- INFO / GUIDE MODAL -->
    <div x-show="modals.info"
        class="fixed inset-0 z-[250] flex items-center justify-center p-6 bg-black/90 backdrop-blur-md" x-cloak
        x-transition @click.self="modals.info=false">
        <div
            class="bg-[#1A1A1E] border border-white/10 rounded-3xl p-6 w-full max-w-sm shadow-2xl relative overflow-y-auto max-h-[85vh] no-scrollbar">
            <div class="flex justify-between items-center mb-6 border-b border-white/5 pb-4">
                <h3 class="text-xl font-bold text-white">Workout Key</h3>
                <button @click="modals.info=false" class="text-slate-500 hover:text-white p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="space-y-6">
                <div class="relative pl-4 border-l-2 border-indigo-500">
                    <h4 class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-1">Workout Tiers</h4>
                    <p class="text-sm text-slate-300 leading-relaxed">
                        <strong class="text-white">T1 (Tier 1):</strong> Your primary heavy compound lift. This
                        determines your progression. Prioritize this.<br>
                        <strong class="text-white">T2 (Tier 2):</strong> Secondary supplemental lift. Lighter weight,
                        higher reps for volume and technique.
                    </p>
                </div>
                <div class="relative pl-4 border-l-2 border-yellow-500">
                    <h4 class="text-xs font-bold text-yellow-500 uppercase tracking-widest mb-1">AMRAP Set</h4>
                    <p class="text-sm text-slate-300 leading-relaxed">
                        <strong class="text-white">As Many Reps As Possible.</strong><br>
                        The final set marked in yellow. Go until you feel you have 1-2 reps left in the tank. Do not go
                        to absolute failure unless safe. Beating the target reps increases your Training Max.
                    </p>
                </div>
                <div class="relative pl-4 border-l-2 border-blue-500">
                    <h4 class="text-xs font-bold text-blue-500 uppercase tracking-widest mb-1">RPE Scale</h4>
                    <p class="text-sm text-slate-300 leading-relaxed">
                        <strong class="text-white">Rate of Perceived Exertion (1-10)</strong><br>
                        <span class="block mt-1 text-xs">
                            <span class="text-white font-bold">10:</span> Max Effort (Could not do another rep)<br>
                            <span class="text-white font-bold">9:</span> Heavy (1 rep in reserve)<br>
                            <span class="text-white font-bold">8:</span> Moderate (2 reps in reserve)<br>
                            <span class="text-white font-bold">7:</span> Speed work (3+ reps in reserve)
                        </span>
                    </p>
                </div>
                <div class="relative pl-4 border-l-2 border-green-500">
                    <h4 class="text-xs font-bold text-green-500 uppercase tracking-widest mb-1">TM (Training Max)</h4>
                    <p class="text-sm text-slate-300 leading-relaxed">
                        The weight value used to calculate all your working sets. It is typically 90% of your true 1 Rep
                        Max to ensure consistent progress without burning out.
                    </p>
                </div>
                <div class="relative pl-4 border-l-2 border-slate-500">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Accessories (OPT)</h4>
                    <p class="text-sm text-slate-300 leading-relaxed">
                        Isolation exercises (T3). These are for muscle hypertrophy and balance. These are optional if
                        you are short on time, but recommended for growth.
                    </p>
                </div>
            </div>
            <button @click="modals.info=false"
                class="w-full mt-8 bg-[#333] text-white font-bold py-3.5 rounded-xl border border-white/10 active:scale-95 transition">Got
                it</button>
        </div>
    </div>

    <!-- POST-WORKOUT RATING MODAL -->
    <div x-show="modals.rating"
        class="fixed inset-0 z-[170] flex items-center justify-center p-6 bg-black/90 backdrop-blur-md" x-cloak
        x-transition>
        <div class="bg-[#1A1A1E] border border-white/10 rounded-3xl p-6 w-full max-w-sm shadow-2xl relative">
            <div class="text-center mb-6">
                <div class="text-4xl mb-3">ðŸ’ª</div>
                <h3 class="text-xl font-bold text-white">Workout Complete!</h3>
                <p class="text-sm text-slate-400 mt-1">How did it feel?</p>
            </div>

            <div class="mb-6">
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block text-center">Session Rating</label>
                <div class="flex justify-center gap-2">
                    <template x-for="i in 5">
                        <button @click="sessionRating = i" class="rating-star text-3xl"
                            :class="i <= sessionRating ? 'opacity-100' : 'opacity-30'"
                            x-text="i <= sessionRating ? 'â­' : 'â˜†'"></button>
                    </template>
                </div>
            </div>

            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-xs font-bold text-slate-500 uppercase">RPE (Exertion)</label>
                    <span class="text-xs font-bold text-indigo-400" x-text="sessionRPE + '/10'"></span>
                </div>
                <input type="range" x-model.number="sessionRPE" min="5" max="10" step="0.5"
                    class="w-full accent-indigo-500">
                <div class="flex justify-between text-[9px] text-slate-600 mt-1">
                    <span>Easy</span>
                    <span>Moderate</span>
                    <span>Max Effort</span>
                </div>
            </div>

            <div class="mb-6">
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Notes (optional)</label>
                <textarea x-model="sessionNotes"
                    class="w-full bg-black border border-white/20 rounded-xl p-3 text-white text-sm outline-none resize-none h-20"
                    placeholder="How did you feel? Any observations..."></textarea>
            </div>

            <button @click="saveSessionRating()"
                class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95">Save &
                Continue</button>
        </div>
    </div>

    <!-- WEIGHT PROMPT -->
    <div x-show="modals.weight"
        class="fixed inset-0 z-[150] flex items-center justify-center p-6 bg-black/90 backdrop-blur-md" x-cloak
        x-transition>
        <div class="bg-[#1A1A1E] border border-white/10 rounded-3xl p-6 w-full max-w-sm shadow-2xl relative">
            <h3 class="text-xl font-bold text-white text-center mb-4">Log Weight</h3>
            <div class="relative mb-6">
                <input type="number" x-model.number="tempBodyWeight" step="0.1"
                    class="w-full bg-black border border-white/20 rounded-2xl p-4 text-2xl font-bold text-white text-center outline-none mono"
                    :placeholder="prefs.weightUnit==='kg'?'75.0':'165.0'">
                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold"
                    x-text="prefs.weightUnit"></span>
            </div>
            <div class="flex gap-3">
                <button @click="modals.weight=false; startSession()"
                    class="flex-1 bg-[#333] text-white font-bold py-3.5 rounded-xl">Skip</button>
                <button @click="logBodyWeight()"
                    class="flex-1 bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg">Log</button>
            </div>
        </div>
    </div>

    <!-- ACHIEVEMENT POPUP -->
    <div x-show="modals.achievement"
        class="fixed inset-0 z-[190] flex items-center justify-center p-6 bg-black/90 backdrop-blur-md" x-cloak
        x-transition>
        <div
            class="bg-gradient-to-br from-indigo-900/50 to-purple-900/50 border border-indigo-500/30 rounded-3xl p-6 w-full max-w-sm shadow-2xl relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-indigo-500/10 via-purple-500/10 to-pink-500/10 shimmer">
            </div>
            <div class="relative z-10 text-center">
                <div class="text-6xl mb-4" x-text="currentAchievement?.icon || 'ðŸ†'"></div>
                <h3 class="text-2xl font-bold text-white mb-2">Achievement Unlocked!</h3>
                <p class="text-lg font-bold text-indigo-400" x-text="currentAchievement?.title"></p>
                <p class="text-sm text-slate-400 mt-2" x-text="currentAchievement?.description"></p>
                <button @click="modals.achievement=false"
                    class="mt-6 bg-white/10 text-white font-bold py-3 px-8 rounded-xl">Awesome!</button>
            </div>
        </div>
    </div>

    <!-- WORKOUT DETAIL MODAL (MODIFIED FOR EDIT/DELETE) -->
    <div x-show="modals.workoutDetail"
        class="fixed inset-0 z-[160] flex items-end sm:items-center justify-center bg-black/90 backdrop-blur-md" x-cloak
        x-transition @click.self="modals.workoutDetail=false">
        <div
            class="bg-[#1A1A1E] w-full max-w-md max-h-[85vh] rounded-t-3xl sm:rounded-3xl border border-white/10 overflow-hidden flex flex-col">
            <div class="sticky top-0 bg-[#1A1A1E] border-b border-white/10 p-4 flex justify-between items-center z-10">
                <div>
                    <h3 class="text-lg font-bold text-white" x-text="selectedLog?.title"></h3>
                    <p class="text-xs text-slate-500" x-text="selectedLog?.date"></p>
                </div>
                <div class="flex items-center gap-2">
                    <!-- EDIT/DELETE CONTROLS -->
                    <template x-if="!isEditingLog">
                        <div class="flex gap-2">
                            <button @click="deleteLog()"
                                class="text-red-400 hover:text-red-300 p-2 rounded hover:bg-red-500/10">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                            <button @click="isEditingLog = true"
                                class="text-blue-400 hover:text-blue-300 p-2 rounded hover:bg-blue-500/10">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </button>
                            <button @click="modals.workoutDetail=false" class="text-slate-500 p-2 hover:text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </template>
                    <template x-if="isEditingLog">
                        <div class="flex gap-2">
                            <button @click="saveLogEdits()"
                                class="text-green-400 hover:text-green-300 p-2 rounded hover:bg-green-500/10">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                                </svg>
                            </button>
                            <button @click="isEditingLog=false" class="text-slate-500 p-2 hover:text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </template>
                </div>
            </div>

            <div class="p-4 overflow-y-auto overflow-x-hidden max-h-[70vh] no-scrollbar space-y-6 flex-1">
                <!-- Summary Stats -->
                <div class="grid grid-cols-4 gap-2">
                    <div class="bg-black/30 rounded-xl p-3 text-center">
                        <template x-if="!isEditingLog">
                            <div class="text-lg font-bold text-white mono" x-text="selectedLog?.duration || '-'"></div>
                        </template>
                        <template x-if="isEditingLog">
                            <input type="number" x-model="selectedLog.duration"
                                class="w-full bg-black border border-white/20 rounded text-center text-white font-mono font-bold">
                        </template>
                        <div class="text-[9px] text-slate-500 uppercase">Minutes</div>
                    </div>
                    <div class="bg-black/30 rounded-xl p-3 text-center">
                        <div class="text-lg font-bold text-white mono" x-text="selectedLog?.totalSets || '-'"></div>
                        <div class="text-[9px] text-slate-500 uppercase">Sets</div>
                    </div>
                    <div class="bg-black/30 rounded-xl p-3 text-center">
                        <div class="text-lg font-bold text-white mono"
                            x-text="formatVolumeShort(selectedLog?.totalVolume)"></div>
                        <div class="text-[9px] text-slate-500 uppercase">Volume</div>
                    </div>
                    <div class="bg-black/30 rounded-xl p-3 text-center">
                        <template x-if="!isEditingLog">
                            <div class="text-lg font-bold text-white"
                                x-text="'â­'.repeat(selectedLog?.rating || 0) || '-'"></div>
                        </template>
                        <template x-if="isEditingLog">
                            <input type="number" min="0" max="5" x-model="selectedLog.rating"
                                class="w-full bg-black border border-white/20 rounded text-center text-white font-mono font-bold">
                        </template>
                        <div class="text-[9px] text-slate-500 uppercase">Rating</div>
                    </div>
                </div>

                <!-- T1 Sets -->
                <div x-show="selectedLog?.setDetails?.t1?.length">
                    <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">
                        <span x-text="selectedLog?.details?.t1"></span> (T1)
                    </h4>
                    <div class="space-y-2">
                        <template x-for="(set, idx) in selectedLog?.setDetails?.t1 || []">
                            <div class="relative set-timeline pl-6">
                                <div class="absolute left-0 top-1 w-4 h-4 rounded-full flex items-center justify-center text-[10px]"
                                    :class="set.failed ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'">
                                    <span x-text="set.failed ? 'âœ•' : 'âœ“'"></span>
                                </div>
                                <div class="bg-black/30 rounded-lg p-3 flex justify-between items-center">
                                    <div>
                                        <span class="text-white font-bold mono" x-text="set.weight"></span>
                                        <span class="text-slate-500 text-xs ml-1" x-text="prefs.weightUnit"></span>
                                        <span class="text-slate-400 text-sm ml-2">Ã—</span>
                                        <span class="font-bold ml-1"
                                            :class="set.amrap ? 'text-yellow-400' : 'text-white'"
                                            x-text="set.performed || set.reps"></span>
                                        <span x-show="set.amrap" class="text-yellow-500 text-xs ml-1">AMRAP</span>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-slate-500"
                                            x-text="set.completedAt ? formatSetTime(set.completedAt) : ''"></div>
                                        <div x-show="set.restAfter" class="text-[10px] text-slate-600"
                                            x-text="'Rest: ' + formatTime(set.restAfter)"></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- T2 Sets -->
                <div x-show="selectedLog?.setDetails?.t2?.length">
                    <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">
                        <span x-text="selectedLog?.setDetails?.t2Name"></span> (T2)
                    </h4>
                    <div class="grid grid-cols-4 gap-2">
                        <template x-for="(set, idx) in selectedLog?.setDetails?.t2 || []">
                            <div class="bg-black/30 rounded-lg p-2 text-center"
                                :class="set.completed ? 'border border-indigo-500/30' : 'opacity-50'">
                                <div class="text-sm font-bold text-white mono" x-text="set.weight"></div>
                                <div class="text-[10px] text-slate-500">Ã—<span x-text="set.reps"></span></div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Accessories -->
                <div x-show="selectedLog?.setDetails?.accessories">
                    <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Accessories</h4>
                    <div class="space-y-2">
                        <template x-for="acc in selectedLog?.setDetails?.accessories || []">
                            <div class="bg-black/30 rounded-lg p-3 flex justify-between items-center">
                                <span class="text-white text-sm" x-text="acc.name"></span>
                                <span class="text-slate-400 text-xs"
                                    x-text="acc.completed + '/' + acc.total + ' sets'"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Notes -->
                <div x-show="selectedLog?.notes || isEditingLog">
                    <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Notes</h4>
                    <div class="bg-black/30 rounded-lg p-3">
                        <template x-if="!isEditingLog">
                            <p class="text-sm text-slate-300" x-text="selectedLog?.notes"></p>
                        </template>
                        <template x-if="isEditingLog">
                            <textarea x-model="selectedLog.notes"
                                class="w-full bg-black border border-white/20 rounded p-2 text-white text-sm outline-none resize-none h-24"></textarea>
                        </template>
                    </div>
                </div>

                <!-- PR Indicator -->
                <div x-show="selectedLog?.pr"
                    class="bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border border-yellow-500/30 rounded-xl p-4 text-center">
                    <div class="text-2xl mb-1">ðŸ†</div>
                    <div class="text-sm font-bold text-yellow-400">Training Max Increased!</div>
                    <div class="text-xs text-slate-400">+<span x-text="selectedLog?.increase"></span> <span
                            x-text="prefs.weightUnit"></span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- PREFERENCES -->
    <div x-show="view==='preferences'" class="h-full overflow-y-auto pb-32 no-scrollbar" x-cloak>
        <header class="pt-14 pb-6 px-6 bg-gradient-to-b from-black to-transparent sticky top-0 z-20">
            <h2 class="text-3xl font-extrabold text-white">Settings</h2>
        </header>
        <div class="px-6 space-y-8">
            <div class="glass p-5 rounded-2xl">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Unit</h3>
                <div class="flex gap-3">
                    <template x-for="u in ['lbs','kg']">
                        <button @click="prefs.weightUnit=u; savePrefs()"
                            class="flex-1 py-3 rounded-xl font-bold text-sm transition-all"
                            :class="prefs.weightUnit===u?'bg-indigo-600 text-white shadow-lg':'bg-[#222] text-slate-400 border border-white/10'"
                            x-text="u==='lbs'?'Pounds (lbs)':'Kilograms (kg)'"></button>
                    </template>
                </div>
            </div>

            <div class="glass p-5 rounded-2xl">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Program</h3>
                <div class="space-y-3">
                    <template x-for="(prog, key) in PROGRAMS">
                        <div @click="selectProgram(key)"
                            class="program-card p-4 rounded-xl border border-white/10 cursor-pointer"
                            :class="prefs.program===key?'selected':'bg-[#121214]'">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-white" x-text="prog.name"></h4>
                                    <p class="text-xs text-slate-400 mt-1" x-text="prog.description"></p>
                                    <p class="text-[10px] text-indigo-400 mt-1"
                                        x-text="'Progression: ' + prog.progressionDesc"></p>
                                </div>
                                <div x-show="prefs.program===key"
                                    class="w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center text-white">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                            d="M5 13l4 4L19 7" />
                                    </svg></div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div class="glass p-5 rounded-2xl">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Bar & Plates</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm text-slate-300 mb-2 block">Bar Weight</label>
                        <div class="grid grid-cols-4 gap-2">
                            <template x-for="bar in getBarOptions()">
                                <button @click="prefs.barWeight=bar.weight; savePrefs()"
                                    class="py-2 rounded-lg text-xs font-bold transition-all"
                                    :class="prefs.barWeight===bar.weight?'bg-indigo-600 text-white':'bg-[#222] text-slate-400 border border-white/10'">
                                    <div x-text="bar.weight"></div>
                                    <div class="text-[9px] opacity-70" x-text="bar.name"></div>
                                </button>
                            </template>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-white">Microplates Available</span>
                        <button @click="prefs.microplates=!prefs.microplates; savePrefs()"
                            class="w-12 h-7 rounded-full transition-colors relative"
                            :class="prefs.microplates?'bg-indigo-600':'bg-[#333]'">
                            <div class="absolute top-1 left-1 w-5 h-5 bg-white rounded-full transition-transform"
                                :class="prefs.microplates?'translate-x-5':''"></div>
                        </button>
                    </div>
                    <p class="text-[10px] text-slate-500">Microplates enable 1.25<span x-text="prefs.weightUnit"></span>
                        increments</p>
                </div>
            </div>

            <div class="glass p-5 rounded-2xl">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Timers</h3>
                <div class="space-y-4">
                    <template
                        x-for="t in [{l:'Main (T1)',k:'restT1',m:300},{l:'Secondary (T2)',k:'restT2',m:180},{l:'Accessory (T3)',k:'restT3',m:120}]">
                        <div>
                            <label class="text-sm text-slate-300 mb-2 block" x-text="t.l"></label>
                            <div class="flex items-center gap-3">
                                <input type="range" x-model.number="prefs[t.k]" min="30" :max="t.m" step="15"
                                    class="flex-1 accent-indigo-500" @change="savePrefs()">
                                <span class="mono text-white font-bold w-16 text-right"
                                    x-text="formatTime(prefs[t.k])"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div class="glass p-5 rounded-2xl">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Options</h3>
                <div class="space-y-3">
                    <template
                        x-for="opt in [{k:'timerSound',l:'Timer Sound'},{k:'vibration',l:'Vibration'},{k:'autoStartTimer',l:'Auto-start Timer'},{k:'showPreviousWorkout',l:'Show Previous Workout'},{k:'autoDeload',l:'Auto-suggest Deload'}]">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-white" x-text="opt.l"></span>
                            <button @click="prefs[opt.k]=!prefs[opt.k]; savePrefs()"
                                class="w-12 h-7 rounded-full transition-colors relative"
                                :class="prefs[opt.k]?'bg-indigo-600':'bg-[#333]'">
                                <div class="absolute top-1 left-1 w-5 h-5 bg-white rounded-full transition-transform"
                                    :class="prefs[opt.k]?'translate-x-5':''"></div>
                            </button>
                        </div>
                    </template>
                </div>
            </div>

            <div class="glass p-5 rounded-2xl">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Body Weight</h3>
                <div class="h-40 relative"><canvas id="bodyWeightChart"></canvas></div>
                <div class="mt-4 grid grid-cols-3 gap-3 text-center text-white font-bold mono">
                    <div class="bg-black/30 rounded-lg p-3">
                        <div class="text-[10px] text-slate-500 uppercase font-sans">Current</div><span
                            x-text="getBW('last')"></span>
                    </div>
                    <div class="bg-black/30 rounded-lg p-3">
                        <div class="text-[10px] text-slate-500 uppercase font-sans">Min</div><span
                            class="text-green-400" x-text="getBW('min')"></span>
                    </div>
                    <div class="bg-black/30 rounded-lg p-3">
                        <div class="text-[10px] text-slate-500 uppercase font-sans">Max</div><span class="text-red-400"
                            x-text="getBW('max')"></span>
                    </div>
                </div>
            </div>

            <div class="glass p-5 rounded-2xl">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Training Maxes</h3>
                <div class="space-y-3">
                    <template x-for="lift in getLifts()">
                        <div class="flex items-center gap-3">
                            <label class="text-sm text-slate-300 w-24" x-text="lift"></label>
                            <input type="number" x-model.number="tms[lift]"
                                class="flex-1 bg-black border border-white/20 rounded-lg p-2 text-white font-bold mono text-center outline-none">
                            <div class="text-[10px] text-slate-500 w-16 text-right">
                                <span x-text="'1RM: ' + Math.round(tms[lift]/0.9)"></span>
                            </div>
                        </div>
                    </template>
                </div>
                <button @click="saveData()"
                    class="w-full mt-4 bg-green-600/20 text-green-400 font-bold py-3 rounded-xl border border-green-500/30">Save
                    TMs</button>
            </div>

            <!-- Achievements Section -->
            <div class="glass p-5 rounded-2xl">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Achievements</h3>
                <div class="grid grid-cols-4 gap-3">
                    <template x-for="ach in ACHIEVEMENTS">
                        <div class="text-center" :class="hasAchievement(ach.id) ? '' : 'opacity-30'">
                            <div class="text-2xl mb-1" x-text="ach.icon"></div>
                            <div class="text-[9px] text-slate-400" x-text="ach.title"></div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Personal Records -->
            <div class="glass p-5 rounded-2xl">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Personal Records</h3>
                <div class="space-y-3">
                    <template x-for="lift in getLifts()">
                        <div class="flex items-center justify-between bg-black/30 rounded-lg p-3">
                            <span class="text-sm text-slate-300" x-text="lift"></span>
                            <div class="text-right">
                                <span class="text-white font-bold mono" x-text="prs[lift]?.weight || '-'"></span>
                                <span class="text-slate-500 text-xs ml-1" x-text="prefs.weightUnit"></span>
                                <div class="text-[9px] text-slate-600" x-text="prs[lift]?.date || ''"></div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- SETUP -->
    <div x-show="view==='setup'" x-transition.opacity
        class="fixed inset-0 z-[100] bg-black flex flex-col justify-center p-8 space-y-6 overflow-y-auto">
        <div class="text-center pt-8">
            <h1 class="text-4xl font-extrabold text-white tracking-tighter mb-2">LIFT <span
                    class="text-indigo-500">ULTIMATE</span></h1>
            <p class="text-slate-500">Configure your training</p>
        </div>
        <div class="bg-[#1A1A1E] border border-white/10 rounded-2xl p-4">
            <div class="flex gap-3">
                <template x-for="u in ['lbs','kg']"><button @click="prefs.weightUnit=u"
                        class="flex-1 py-3 rounded-xl font-bold text-sm transition-all"
                        :class="prefs.weightUnit===u?'bg-indigo-600 text-white':'bg-[#333] text-slate-400'"
                        x-text="u"></button></template>
            </div>
        </div>
        <div
            class="bg-[#1A1A1E] border border-white/10 rounded-2xl p-4 max-h-48 overflow-y-auto no-scrollbar space-y-2">
            <template x-for="(prog, key) in PROGRAMS">
                <button @click="prefs.program=key" class="w-full text-left p-3 rounded-xl border transition-all"
                    :class="prefs.program===key?'border-indigo-500 bg-indigo-500/10':'border-white/10 bg-black/30'">
                    <div class="font-bold text-white text-sm" x-text="prog.name"></div>
                    <div class="text-xs text-slate-400" x-text="prog.daysPerWeek + ' days â€¢ ' + prog.progressionDesc">
                    </div>
                </button>
            </template>
        </div>
        <div class="space-y-3">
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">1 Rep Maxes</p>
            <template x-for="lift in getLifts()">
                <div class="relative">
                    <input type="number" x-model.number="setup[lift]"
                        class="w-full bg-[#1A1A1E] border border-white/10 rounded-2xl p-4 text-xl font-bold text-white outline-none mono"
                        :placeholder="lift">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 text-sm"
                        x-text="prefs.weightUnit"></span>
                </div>
            </template>
        </div>
        <button @click="finishSetup()"
            class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform">Start
            Program</button>
    </div>

    <!-- DASHBOARD -->
    <div x-show="view==='dashboard'" class="h-full overflow-y-auto pb-32 no-scrollbar">
        <header
            class="pt-14 pb-4 px-6 flex justify-between items-center bg-gradient-to-b from-black to-transparent sticky top-0 z-20">
            <div>
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-0.5"
                    x-text="PROGRAMS[prefs.program].name"></p>
                <h2 class="text-2xl font-extrabold text-white">Week <span class="text-indigo-500"
                        x-text="currentWeek"></span></h2>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 bg-[#1A1A1E] px-3 py-1.5 rounded-full border border-white/5">
                    <span class="text-lg">ðŸ”¥</span><span class="text-sm font-bold text-white mono"
                        x-text="streak">0</span>
                </div>
                <div x-show="Object.keys(prs).length > 0"
                    class="flex items-center gap-1 bg-yellow-500/10 px-2 py-1 rounded-full border border-yellow-500/20">
                    <span class="text-sm">ðŸ†</span><span class="text-xs font-bold text-yellow-400"
                        x-text="Object.keys(prs).length"></span>
                </div>
            </div>
        </header>

        <div class="px-6 space-y-6">
            <!-- Deload Warning Banner -->
            <div x-show="getDaysOff() >= 7 && prefs.autoDeload"
                class="deload-warning rounded-2xl p-4 flex items-center gap-3">
                <div class="w-10 h-10 bg-orange-500/20 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01" />
                    </svg>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-bold text-orange-400">Welcome Back!</p>
                    <p class="text-xs text-slate-400">You've been away <span x-text="getDaysOff()"></span> days.
                        Consider a deload.</p>
                </div>
            </div>

            <!-- Recovery Indicators -->
            <div class="glass p-4 rounded-2xl" x-show="history.length > 0">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Recovery Status</h3>
                <div class="grid grid-cols-2 gap-3">
                    <template x-for="muscle in getMuscleRecovery()">
                        <div class="bg-black/30 rounded-lg p-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-slate-400" x-text="muscle.name"></span>
                                <span class="text-[10px] font-bold"
                                    :class="muscle.status === 'Ready' ? 'text-green-400' : muscle.status === 'Recovering' ? 'text-yellow-400' : 'text-red-400'"
                                    x-text="muscle.status"></span>
                            </div>
                            <div class="h-1.5 bg-black/50 rounded-full overflow-hidden">
                                <div class="h-full recovery-bar rounded-full"
                                    :class="muscle.recovery >= 100 ? 'bg-green-500' : muscle.recovery >= 50 ? 'bg-yellow-500' : 'bg-red-500'"
                                    :style="'width: ' + Math.min(100, muscle.recovery) + '%'"></div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Main Workout Card -->
            <div
                class="relative overflow-hidden rounded-[2rem] bg-[#121214] border border-white/10 p-6 shadow-2xl shadow-black">
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-indigo-500/10 blur-[50px] rounded-full"></div>
                <div class="relative z-10">
                    <!-- Navigation for Workout Selection -->
                    <div class="flex justify-between items-center mb-4">
                        <button @click="changePreviewDay(-1)"
                            class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-slate-400 active:scale-95 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <div class="text-center">
                            <div class="flex items-center justify-center gap-2">
                                <div
                                    class="inline-block text-indigo-400 text-[10px] font-bold uppercase tracking-widest">
                                    Day <span x-text="previewDayIdx + 1"></span>
                                    <span x-show="prefs.program==='531' && isDeloadWeek()"
                                        class="ml-1 text-yellow-500">DELOAD</span>
                                </div>
                                <div x-show="previewDayIdx === currentDayIdx"
                                    class="px-1.5 py-0.5 rounded bg-indigo-600 text-[9px] font-bold text-white">Next
                                </div>
                            </div>
                        </div>
                        <button @click="changePreviewDay(1)"
                            class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-slate-400 active:scale-95 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>

                    <div @click="checkDeloadAndStart()"
                        class="cursor-pointer active:scale-[0.98] transition-transform group">
                        <h3 class="text-3xl font-extrabold text-white mb-1" x-text="getWorkout().title"></h3>
                        <p class="text-slate-400 text-sm font-medium" x-text="getWorkout().focus"></p>

                        <!-- Estimated Duration -->
                        <div class="mt-3 flex items-center gap-4 text-xs text-slate-500">
                            <span>â±ï¸ ~<span x-text="getEstimatedDuration()"></span> min</span>
                            <span>ðŸ“Š <span x-text="getWorkout().t1"></span> + <span
                                    x-text="getWorkout().t2"></span></span>
                        </div>

                        <div class="mt-6 flex items-center justify-between">
                            <div class="flex items-center gap-2 text-sm font-bold text-white">
                                <span
                                    class="bg-indigo-600 rounded-full w-8 h-8 flex items-center justify-center pulse-glow"><svg
                                        class="w-4 h-4 ml-0.5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z" />
                                    </svg></span>
                                <span class="ml-1">Start Workout</span>
                            </div>
                            <!-- Jump to Scheduled button -->
                            <button @click.stop="previewDayIdx = currentDayIdx" x-show="previewDayIdx !== currentDayIdx"
                                class="text-[10px] font-bold text-slate-500 bg-white/5 px-2 py-1 rounded-full border border-white/5 hover:bg-white/10">
                                Jump to Scheduled
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-2 gap-3">
                <button @click="repeatLastWorkout()" x-show="getLastSimilarWorkout()"
                    class="glass p-4 rounded-2xl text-left active:scale-95 transition">
                    <div class="text-[10px] font-bold text-slate-500 uppercase">Repeat Last</div>
                    <div class="text-sm font-bold text-white mt-1" x-text="getLastSimilarWorkout()?.title || ''"></div>
                    <div class="text-xs text-slate-500" x-text="getLastSimilarWorkout()?.date || ''"></div>
                </button>
                <button @click="startCustomSession()"
                    class="glass p-4 rounded-2xl text-left active:scale-95 transition">
                    <div class="text-[10px] font-bold text-slate-500 uppercase">Custom</div>
                    <div class="text-sm font-bold text-white mt-1">Free Workout</div>
                    <div class="text-xs text-slate-500">Build your own</div>
                </button>
            </div>

            <!-- TM Cards -->
            <div class="grid grid-cols-2 gap-3">
                <template x-for="lift in getLifts()">
                    <div class="glass p-4 rounded-2xl relative overflow-hidden">
                        <div x-show="prs[lift]" class="absolute top-2 right-2">
                            <span class="text-xs">ðŸ†</span>
                        </div>
                        <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest" x-text="lift"></div>
                        <div class="flex items-end gap-1 mt-1">
                            <span class="text-2xl font-bold text-white mono" x-text="Math.round(tms[lift])"></span>
                            <span class="text-[10px] font-bold text-slate-600 mb-1.5">TM</span>
                        </div>
                        <div class="text-[10px] text-slate-600 mt-1">Est 1RM: <span
                                x-text="Math.round(tms[lift]/0.9)"></span></div>
                        <div x-show="prefs.program==='gzclp'" class="text-[9px] text-indigo-400 mt-1">
                            Stage: <span x-text="programState[lift]?.stage || 1"></span>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Chart -->
            <div class="glass p-5 rounded-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Est. 1RM History</h3>
                    <select x-model="chartLift" @change="renderMainChart()"
                        class="bg-black/50 border border-white/10 text-[10px] font-bold text-white rounded px-2 py-1 outline-none">
                        <template x-for="lift in getLifts()">
                            <option :value="lift" x-text="lift"></option>
                        </template>
                    </select>
                </div>
                <div class="h-40 relative"><canvas id="mainChart"></canvas></div>
            </div>

            <!-- Weekly Volume Chart -->
            <div class="glass p-5 rounded-2xl">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Weekly Volume</h3>
                <div class="h-32 relative"><canvas id="volumeChart"></canvas></div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-4 gap-3">
                <div class="glass p-3 rounded-2xl text-center">
                    <div class="text-xl font-bold text-white mono" x-text="history.length"></div>
                    <div class="text-[9px] text-slate-500 uppercase">Workouts</div>
                </div>
                <div class="glass p-3 rounded-2xl text-center">
                    <div class="text-xl font-bold text-white mono" x-text="formatVolume()"></div>
                    <div class="text-[9px] text-slate-500 uppercase">Vol</div>
                </div>
                <div class="glass p-3 rounded-2xl text-center">
                    <div class="text-xl font-bold text-white mono" x-text="getAvgDuration()"></div>
                    <div class="text-[9px] text-slate-500 uppercase">Avg Min</div>
                </div>
                <div class="glass p-3 rounded-2xl text-center">
                    <div class="text-xl font-bold text-white mono" x-text="getTotalPRs()"></div>
                    <div class="text-[9px] text-slate-500 uppercase">PRs</div>
                </div>
            </div>
        </div>
    </div>

    <!-- CALENDAR/HISTORY -->
    <div x-show="view==='calendar'" class="h-full overflow-y-auto pb-32 no-scrollbar" x-cloak>
        <header class="pt-14 pb-6 px-6 bg-gradient-to-b from-black to-transparent sticky top-0 z-20">
            <h2 class="text-3xl font-extrabold text-white">History</h2>
        </header>
        <div class="px-6 space-y-8">
            <div class="glass p-5 rounded-3xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-white" x-text="cal.monthName"></h3>
                    <div class="flex gap-2">
                        <button @click="changeMonth(-1)" class="p-1 hover:text-white text-slate-500"><svg
                                class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7" />
                            </svg></button>
                        <button @click="changeMonth(1)" class="p-1 hover:text-white text-slate-500"><svg class="w-5 h-5"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg></button>
                    </div>
                </div>
                <div class="cal-grid mb-2 text-center">
                    <template x-for="d in ['S','M','T','W','T','F','S']"><span
                            class="text-[10px] font-bold text-slate-600" x-text="d"></span></template>
                </div>
                <div class="cal-grid">
                    <template x-for="day in cal.days">
                        <div @click="day.hasLog && showDayLogs(day)"
                            :class="['cal-day', day.isToday?'cal-today':'', day.hasLog?'cal-active cursor-pointer':'']"
                            x-text="day.num"></div>
                    </template>
                </div>
            </div>

            <!-- Filters -->
            <div class="flex gap-2 overflow-x-auto no-scrollbar py-1">
                <button @click="historyFilter='all'"
                    class="flex-shrink-0 px-4 py-2 rounded-full text-xs font-bold transition"
                    :class="historyFilter==='all'?'bg-indigo-600 text-white':'bg-[#222] text-slate-400'">All</button>
                <template x-for="lift in getLifts()">
                    <button @click="historyFilter=lift"
                        class="flex-shrink-0 px-4 py-2 rounded-full text-xs font-bold transition"
                        :class="historyFilter===lift?'bg-indigo-600 text-white':'bg-[#222] text-slate-400'"
                        x-text="lift"></button>
                </template>
            </div>

            <div>
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Workout Log</h3>
                <div class="space-y-3">
                    <template x-for="log in getFilteredHistory()">
                        <div @click="openWorkoutDetail(log)"
                            class="glass p-4 rounded-2xl cursor-pointer active:scale-[0.98] transition">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <div class="text-sm font-bold text-white" x-text="log.title"></div>
                                        <div x-show="log.pr"
                                            class="pr-badge px-1.5 py-0.5 rounded text-[9px] font-bold text-black">PR
                                        </div>
                                    </div>
                                    <div class="text-xs text-slate-500" x-text="log.date"></div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div x-show="log.rating" class="text-xs" x-text="'â­'.repeat(log.rating)"></div>
                                    <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 5l7 7-7 7" />
                                    </svg>
                                </div>
                            </div>

                            <!-- Quick Stats Row -->
                            <div class="flex gap-3 text-[10px]">
                                <span class="text-slate-500">â±ï¸ <span class="text-slate-300"
                                        x-text="log.duration + ' min'"></span></span>
                                <span class="text-slate-500">ðŸ“Š <span class="text-slate-300"
                                        x-text="formatVolumeShort(log.totalVolume)"></span></span>
                                <span x-show="log.totalSets" class="text-slate-500">Sets: <span class="text-slate-300"
                                        x-text="log.completedSets + '/' + log.totalSets"></span></span>
                                <span x-show="log.increase" class="text-green-400">TM +<span
                                        x-text="log.increase"></span></span>
                            </div>
                        </div>
                    </template>
                    <div x-show="!history.length" class="text-center text-slate-500 text-sm py-8">No workouts yet. Start
                        your first session!</div>
                </div>
            </div>

            <div class="flex gap-3">
                <button @click="exportData()"
                    class="flex-1 bg-[#222] text-xs font-bold py-3 rounded-xl border border-white/10">Export</button>
                <button @click="$refs.import.click()"
                    class="flex-1 bg-[#222] text-xs font-bold py-3 rounded-xl border border-white/10">Import</button>
                <input type="file" x-ref="import" class="hidden" @change="importData($event)">
                <button @click="resetAll()"
                    class="flex-1 bg-red-900/10 text-xs font-bold py-3 rounded-xl border border-red-500/20 text-red-400">Reset</button>
            </div>
        </div>
    </div>

    <!-- WORKOUT SESSION -->
    <div x-show="view==='workout'" class="fixed inset-0 z-50 bg-black overflow-y-auto" x-cloak>
        <div
            class="sticky top-0 bg-black/90 backdrop-blur-md border-b border-white/5 p-4 flex justify-between items-center z-30">
            <button @click="cancelWorkout()" class="text-slate-400 text-sm font-bold">Cancel</button>
            <div class="text-center">
                <div class="text-white font-bold text-sm" x-text="session.title"></div>
                <button @click="modals.info=true"
                    class="flex items-center justify-center gap-1 mx-auto active:opacity-70 group">
                    <span class="text-[10px] text-indigo-500 font-bold uppercase">In Progress</span>
                    <svg class="w-3 h-3 text-indigo-500 group-hover:text-indigo-400" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>
            <button @click="finishSession()"
                class="bg-indigo-600 px-4 py-1.5 rounded-full text-xs font-bold text-white shadow-lg">Finish</button>
        </div>

        <div class="bg-[#0A0A0A] border-b border-white/5 py-2 flex justify-center gap-4 text-xs text-slate-400 mono">
            <span x-text="sessionTimerStr"></span>
            <span class="text-slate-600">|</span>
            <span x-text="getSessionProgress() + '% complete'"></span>
        </div>

        <!-- TIMER -->
        <div x-show="timer.active" x-transition
            class="sticky top-24 z-20 mx-auto max-w-[280px] bg-[#1A1A1E] border border-white/10 rounded-full shadow-2xl flex items-center justify-between p-1 pr-4 overflow-hidden mt-2">
            <div class="absolute inset-0 bg-indigo-600/20 origin-left transition-transform duration-1000 linear"
                :style="`transform: scaleX(${timer.pct})`"></div>
            <div class="flex items-center gap-2 relative z-10">
                <button @click="adjustTimer(-15)"
                    class="w-8 h-8 rounded-full text-slate-400 hover:bg-white/5">-</button>
                <span class="text-white font-bold mono w-14 text-center text-lg" x-text="formatTime(timer.rem)"></span>
                <button @click="adjustTimer(15)" class="w-8 h-8 rounded-full text-slate-400 hover:bg-white/5">+</button>
            </div>
            <button @click="stopTimer()" class="relative z-10 text-[10px] font-bold text-red-400">SKIP</button>
        </div>

        <div class="p-4 space-y-8 pb-40">
            <!-- Previous Workout Comparison -->
            <div x-show="prefs.showPreviousWorkout && previousWorkout"
                class="bg-slate-900/50 border border-slate-700/50 rounded-2xl p-4">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Last Time</h4>
                    <span class="text-[10px] text-slate-600" x-text="previousWorkout?.date"></span>
                </div>
                <div class="grid grid-cols-3 gap-2 text-center text-xs">
                    <div>
                        <div class="text-slate-400">Duration</div>
                        <div class="text-white font-bold" x-text="(previousWorkout?.duration || '-') + ' min'"></div>
                    </div>
                    <div>
                        <div class="text-slate-400">Top Set</div>
                        <div class="text-white font-bold" x-text="previousWorkout?.topSet || '-'"></div>
                    </div>
                    <div>
                        <div class="text-slate-400">AMRAP</div>
                        <div class="text-white font-bold" x-text="previousWorkout?.amrapResult || '-'"></div>
                    </div>
                </div>
            </div>

            <!-- WARMUPS -->
            <div class="bg-indigo-900/10 border border-indigo-500/20 rounded-2xl overflow-hidden">
                <button @click="showWarmups=!showWarmups" class="w-full flex justify-between items-center p-3">
                    <span class="text-xs font-bold text-indigo-400 uppercase tracking-widest">Warm-up Sets</span>
                    <svg class="w-4 h-4 text-indigo-400 transition-transform" :class="showWarmups?'rotate-180':''"
                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div x-show="showWarmups" x-collapse class="px-3 pb-3 grid grid-cols-4 gap-2">
                    <template x-for="wu in generateWarmups()">
                        <div class="bg-black/40 rounded-lg p-2 text-center border border-white/5">
                            <div class="text-sm font-bold text-white mono" x-text="Math.round(wu.w)"></div>
                            <div class="text-[9px] text-slate-400">x<span x-text="wu.r"></span></div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- T1 -->
            <div x-show="session.t1?.sets">
                <h3 class="text-2xl font-extrabold text-white mb-4 flex justify-between"><span
                        x-text="session.t1?.name"></span><span
                        class="text-[10px] px-2 py-1 rounded bg-white/5 border border-white/10 text-slate-400 uppercase font-bold">Tier
                        1</span></h3>
                <div class="space-y-2">
                    <template x-for="(set, i) in session.t1?.sets">
                        <div class="glass p-3 rounded-xl flex items-center justify-between transition-all"
                            :class="[set.completed?(set.failed?'failed-set':'border-green-500/30 bg-green-500/5'):'']">
                            <div class="flex items-center gap-3">
                                <div class="flex flex-col items-center">
                                    <span class="text-xs font-bold text-slate-600 w-4" x-text="i+1"></span>
                                    <span x-show="set.completedAt" class="text-[8px] text-slate-700"
                                        x-text="formatSetTime(set.completedAt)"></span>
                                </div>
                                <div @click="openPlateCalc(set.weight)">
                                    <div class="text-xl font-bold text-white mono"><span
                                            x-text="Math.round(set.weight)"></span> <span
                                            class="text-xs text-slate-500 ml-1 font-sans"
                                            x-text="prefs.weightUnit"></span></div>
                                    <div class="text-[10px] font-bold"
                                        :class="set.amrap?'text-yellow-500':'text-slate-500'"
                                        x-text="set.amrap ? set.reps+'+ AMRAP' : set.reps+' reps'"></div>
                                </div>
                            </div>
                            <template x-if="set.amrap">
                                <div class="flex gap-2 items-center">
                                    <div class="flex flex-col items-end"><label
                                            class="text-[8px] text-slate-500 uppercase">Reps</label><input type="number"
                                            x-model="set.performed" @input="completeSet(set,'t1',i)"
                                            class="w-12 h-8 bg-black border border-white/20 rounded-lg text-center text-white font-bold focus:border-yellow-500 outline-none mono">
                                    </div>
                                    <div x-show="set.performed > set.reps" class="text-green-400 text-xs">+<span
                                            x-text="set.performed - set.reps"></span></div>
                                </div>
                            </template>
                            <template x-if="!set.amrap">
                                <div class="flex items-center gap-2">
                                    <button
                                        @click="set.failed=!set.failed; set.completed=true; set.completedAt=Date.now(); saveSession()"
                                        class="w-8 h-8 rounded-lg border flex items-center justify-center transition text-xs"
                                        :class="set.failed?'bg-red-500 border-red-500 text-white':'border-white/10 text-slate-500 hover:text-red-400'">âœ•</button>
                                    <button @click="completeSet(set,'t1',i)"
                                        class="w-10 h-10 rounded-lg border flex items-center justify-center transition"
                                        :class="set.completed && !set.failed?'bg-green-500 border-green-500 text-black shadow-[0_0_15px_rgba(34,197,94,0.4)]':'border-white/10'"><svg
                                            x-show="set.completed && !set.failed" class="w-5 h-5" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M5 13l4 4L19 7" />
                                        </svg></button>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- Failed Set Recommendation -->
                <div x-show="getFailedT1Count() >= 2"
                    class="mt-3 bg-red-900/20 border border-red-500/30 rounded-xl p-3 text-center">
                    <p class="text-xs text-red-400">Multiple failed sets detected. Adaptation will occur on finish.</p>
                </div>
            </div>

            <!-- T2 -->
            <div x-show="session.t2?.sets">
                <h3 class="text-lg font-bold text-slate-300 mb-3 flex justify-between"><span
                        x-text="session.t2?.name"></span><span
                        class="text-[10px] px-2 py-1 rounded bg-white/5 border border-white/10 text-slate-400 uppercase font-bold">Tier
                        2</span></h3>
                <div class="grid grid-cols-4 gap-2">
                    <template x-for="(set, i) in session.t2?.sets">
                        <button @click="completeSet(set,'t2',i)"
                            class="glass w-full aspect-square rounded-xl flex flex-col items-center justify-center relative active:scale-95 transition"
                            :class="[set.completed?(set.failed?'failed-set':'border-indigo-500/50 bg-indigo-500/10 shadow-[0_0_10px_rgba(99,102,241,0.2)]'):'']">
                            <span class="text-sm font-bold text-white mono" x-text="Math.round(set.weight)"></span>
                            <span class="text-[9px] text-slate-500 mt-1">x<span x-text="set.reps"></span></span>
                            <span x-show="set.completedAt" class="absolute bottom-1 text-[7px] text-slate-600"
                                x-text="formatSetTime(set.completedAt)"></span>
                        </button>
                    </template>
                </div>
            </div>

            <!-- ACCESSORIES -->
            <div x-show="session.acc?.length" class="pt-6 border-t border-white/5">
                <h3 class="text-sm font-bold text-slate-400 mb-4 uppercase tracking-widest">Accessories</h3>
                <div class="space-y-4">
                    <template x-for="acc in session.acc">
                        <div class="glass p-4 rounded-xl">
                            <div class="flex justify-between items-center mb-2"><span
                                    class="text-sm font-bold text-white" x-text="acc.name"></span><span
                                    class="text-[10px] bg-white/10 px-2 py-1 rounded text-slate-300"
                                    x-text="acc.reps"></span></div>
                            <div class="flex gap-2">
                                <template x-for="n in acc.sets">
                                    <button @click="toggleAcc(acc.name, n)"
                                        class="h-8 flex-1 rounded border text-xs font-bold transition"
                                        :class="isAccDone(acc.name, n)?'bg-slate-200 text-black border-slate-200':'border-white/10 text-slate-500'"><span
                                            x-show="!isAccDone(acc.name, n)" x-text="n"></span><span
                                            x-show="isAccDone(acc.name, n)">âœ“</span></button>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Session Notes -->
            <div class="glass p-4 rounded-xl">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 block">Quick Notes</label>
                <textarea x-model="session.notes" @input="saveSession()"
                    class="w-full bg-black/50 border border-white/10 rounded-lg p-3 text-white text-sm outline-none resize-none h-16"
                    placeholder="How's it going?"></textarea>
            </div>

            <div class="flex gap-3">
                <button @click="addSet()"
                    class="flex-1 bg-[#1A1A1E] border border-white/10 text-white font-bold py-3 rounded-xl text-sm">+
                    Add Set</button>
                <button @click="modals.onerm=true"
                    class="flex-1 bg-[#1A1A1E] border border-white/10 text-white font-bold py-3 rounded-xl text-sm">ðŸ§®
                    1RM Calc</button>
            </div>
        </div>
    </div>

    <!-- 1RM CALC MODAL -->
    <div x-show="modals.onerm"
        class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm p-4"
        x-cloak @click.self="modals.onerm=false">
        <div class="bg-[#1A1A1E] w-full max-w-sm rounded-3xl p-6 border border-white/10">
            <h3 class="text-lg font-bold text-white mb-4 text-center">1RM Calculator</h3>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div><label class="text-[10px] text-slate-500 font-bold uppercase mb-2 block">Weight</label><input
                        type="number" x-model.number="calc.w"
                        class="w-full bg-black border border-white/20 rounded-xl p-3 text-xl font-bold text-white text-center mono outline-none">
                </div>
                <div><label class="text-[10px] text-slate-500 font-bold uppercase mb-2 block">Reps</label><input
                        type="number" x-model.number="calc.r"
                        class="w-full bg-black border border-white/20 rounded-xl p-3 text-xl font-bold text-white text-center mono outline-none">
                </div>
            </div>
            <div class="bg-indigo-500/10 border border-indigo-500/20 rounded-2xl p-6 text-center mb-6">
                <div class="text-5xl font-extrabold text-white mono" x-text="Math.round(calc.w * (1 + calc.r/30)) || 0">
                </div>
                <div class="text-xs text-slate-400 mt-2">Estimated 1RM (Epley)</div>
            </div>
            <!-- Percentage Table -->
            <div class="grid grid-cols-5 gap-2 mb-6">
                <template x-for="pct in [95,90,85,80,75]">
                    <div class="bg-black/30 rounded-lg p-2 text-center">
                        <div class="text-[10px] text-slate-500" x-text="pct + '%'"></div>
                        <div class="text-sm font-bold text-white mono"
                            x-text="Math.round(calc.w * (1 + calc.r/30) * pct / 100) || 0"></div>
                    </div>
                </template>
            </div>
            <button @click="modals.onerm=false"
                class="w-full bg-[#333] text-white font-bold py-4 rounded-xl">Close</button>
        </div>
    </div>

    <!-- PLATE CALC MODAL -->
    <div x-show="plate.open"
        class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm p-4"
        x-cloak @click.self="plate.open=false">
        <div class="bg-[#1A1A1E] w-full max-w-sm rounded-3xl p-6 border border-white/10">
            <div class="text-center mb-8">
                <div class="text-6xl font-extrabold text-white mono tracking-tighter" x-text="plate.w"></div>
                <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mt-2">Target Load (<span
                        x-text="prefs.weightUnit"></span>)</div>
            </div>
            <div class="flex justify-center items-center gap-1 mb-10 h-24">
                <div class="h-20 w-4 bg-slate-700 rounded-sm border border-slate-600"></div>
                <template x-for="p in plate.plates">
                    <div class="h-20 w-8 rounded flex items-center justify-center text-xs font-bold shadow-lg"
                        :class="plateColors[p]||'bg-gray-400 text-black'" x-text="p"></div>
                </template>
            </div>
            <div class="text-center text-sm text-slate-400 mb-6">Per side: <span
                    x-text="plate.plates.join(' + ') || 'Empty bar'"></span></div>
            <button @click="plate.open=false"
                class="w-full bg-[#333] text-white font-bold py-4 rounded-xl">Close</button>
        </div>
    </div>

    <!-- NAV -->
    <nav x-show="view!=='setup' && view!=='workout'"
        class="fixed bottom-0 w-full nav-glass pb-safe pt-2 px-6 z-40 flex justify-between items-center h-20">
        <template
            x-for="item in [{id:'dashboard',l:'Train',i:'M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10'},{id:'calendar',l:'History',i:'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'},{id:'preferences',l:'Settings',i:'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z'}]">
            <button @click="navigate(item.id)" class="flex-1 flex flex-col items-center gap-1 transition"
                :class="view===item.id?'text-indigo-400':'text-slate-500'">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" :d="item.i" />
                </svg>
                <span class="text-[10px] font-bold" x-text="item.l"></span>
            </button>
        </template>
    </nav>
</body>

</html>