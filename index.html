<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>nSuns ULTIMATE</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #000000;
            --bg-card: #121214;
            --primary: #6366f1; /* Indigo */
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.03);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Premium Glassmorphism */
        .glass {
            background: #18181b;
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .glass-active {
            background: #202025;
            border-color: rgba(99, 102, 241, 0.3);
        }

        .nav-glass {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }
        .cal-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            border-radius: 10px;
            position: relative;
            color: #555;
            transition: all 0.2s;
        }
        .cal-today { color: white; background: #222; border: 1px solid #444; }
        .cal-active { background: rgba(99, 102, 241, 0.15); color: #818cf8; border: 1px solid rgba(99, 102, 241, 0.4); }
        .cal-active::after {
            content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: #818cf8; border-radius: 50%;
        }

        /* Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        [x-cloak] { display: none !important; }
        
        /* Animations */
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
        .animate-pulse-ring { animation: pulse-ring 2s infinite; }
    </style>
</head>

<body x-data="app()" x-init="init()" class="antialiased h-screen overflow-hidden text-slate-200">

    <!-- ================= SETUP ================= -->
    <div x-show="view === 'setup'" x-transition.opacity class="fixed inset-0 z-[100] bg-black flex flex-col justify-center p-8 space-y-8">
        <div class="text-center">
            <h1 class="text-4xl font-extrabold text-white tracking-tighter mb-2">nSuns <span class="text-indigo-500">ULTIMATE</span></h1>
            <p class="text-slate-500">Enter your 1 Rep Maxes</p>
        </div>
        <div class="space-y-4">
            <template x-for="lift in ['Bench', 'Squat', 'Deadlift', 'OHP']">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest pl-1" x-text="lift"></label>
                    <input type="number" x-model.number="setup[lift]" class="w-full bg-[#1A1A1E] border border-white/10 rounded-2xl p-4 text-xl font-bold text-white focus:border-indigo-500 outline-none transition-colors mt-1 mono" placeholder="0">
                </div>
            </template>
        </div>
        <button @click="finishSetup()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-600/20 active:scale-95 transition-transform">Start Program</button>
    </div>

    <!-- ================= DASHBOARD ================= -->
    <div x-show="view === 'dashboard'" class="h-full overflow-y-auto pb-32 no-scrollbar animate-fade">
        <header class="pt-14 pb-4 px-6 flex justify-between items-center bg-gradient-to-b from-black to-transparent sticky top-0 z-20">
            <div>
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-0.5">Current Cycle</p>
                <h2 class="text-2xl font-extrabold text-white">Week <span class="text-indigo-500" x-text="currentWeek"></span></h2>
            </div>
            <div class="flex items-center gap-2 bg-[#1A1A1E] px-3 py-1.5 rounded-full border border-white/5">
                <span class="text-lg">ðŸ”¥</span>
                <span class="text-sm font-bold text-white mono" x-text="streak">0</span>
            </div>
        </header>

        <div class="px-6 space-y-6">
            <!-- Next Workout Hero -->
            <div @click="startSession()" class="relative overflow-hidden rounded-[2rem] bg-[#121214] border border-white/10 p-6 active:scale-[0.98] transition-transform cursor-pointer group shadow-2xl shadow-black">
                <!-- Background Accent -->
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-indigo-500/10 blur-[50px] rounded-full"></div>
                
                <div class="absolute top-0 right-0 p-6 opacity-10 grayscale group-hover:grayscale-0 transition duration-500">
                    <svg class="w-32 h-32 text-indigo-500" fill="currentColor" viewBox="0 0 24 24"><path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22 14.86 20.57 16.29 22 18.43 19.86 19.86 21.29 21.29 19.86l-1.43-1.43 2.14-2.14 1.43 1.43L22 16.29l-1.43-1.43z"/></svg>
                </div>
                <div class="relative z-10">
                    <div class="inline-block px-3 py-1 rounded-full bg-indigo-500/10 border border-indigo-500/20 text-indigo-400 text-[10px] font-bold uppercase tracking-widest mb-4">Up Next</div>
                    <h3 class="text-3xl font-extrabold text-white mb-1" x-text="getWorkout().title"></h3>
                    <p class="text-slate-400 text-sm font-medium" x-text="getWorkout().focus"></p>
                    <div class="mt-6 flex items-center gap-2 text-sm font-bold text-white">
                        <span class="bg-indigo-600 rounded-full w-8 h-8 flex items-center justify-center shadow-lg shadow-indigo-600/30">
                            <svg class="w-4 h-4 ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        </span>
                        <span class="ml-1">Start Workout</span>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 gap-3">
                <template x-for="(val, lift) in tms">
                    <div class="glass p-4 rounded-2xl">
                        <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest" x-text="lift"></div>
                        <div class="flex items-end gap-1 mt-1">
                            <span class="text-2xl font-bold text-white mono" x-text="val"></span>
                            <span class="text-[10px] font-bold text-slate-600 mb-1.5">TM</span>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Chart -->
            <div class="glass p-5 rounded-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Est. 1RM History</h3>
                    <select x-model="chartLift" @change="renderChart()" class="bg-black/50 border border-white/10 text-[10px] font-bold text-white rounded px-2 py-1 outline-none">
                        <option value="Bench">Bench</option>
                        <option value="Squat">Squat</option>
                        <option value="Deadlift">Deadlift</option>
                        <option value="OHP">OHP</option>
                    </select>
                </div>
                <div class="h-40 relative">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= CALENDAR / HISTORY ================= -->
    <div x-show="view === 'calendar'" class="h-full overflow-y-auto pb-32 no-scrollbar" x-cloak>
        <header class="pt-14 pb-6 px-6 bg-gradient-to-b from-black to-transparent sticky top-0 z-20">
            <h2 class="text-3xl font-extrabold text-white">History</h2>
        </header>

        <div class="px-6 space-y-8">
            
            <!-- Trophy Room (New Premium Feature) -->
            <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                <template x-for="lift in ['Bench','Squat','Deadlift','OHP']">
                    <div class="min-w-[100px] bg-gradient-to-br from-[#1A1A1E] to-[#121214] border border-white/5 p-3 rounded-2xl flex flex-col items-center justify-center">
                        <span class="text-[10px] font-bold text-slate-500 uppercase" x-text="lift"></span>
                        <span class="text-xl font-bold text-indigo-400 mono mt-1" x-text="getBest1RM(lift)"></span>
                        <span class="text-[8px] text-slate-600">Best 1RM</span>
                    </div>
                </template>
            </div>

            <!-- Calendar Widget -->
            <div class="glass p-5 rounded-3xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-white" x-text="calendar.monthName"></h3>
                    <div class="flex gap-2">
                        <button @click="changeMonth(-1)" class="p-1 hover:text-white text-slate-500"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                        <button @click="changeMonth(1)" class="p-1 hover:text-white text-slate-500"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                    </div>
                </div>
                
                <div class="grid grid-cols-7 gap-2 mb-2 text-center">
                    <template x-for="d in ['S','M','T','W','T','F','S']"><span class="text-[10px] font-bold text-slate-600" x-text="d"></span></template>
                </div>
                
                <div class="calendar-grid">
                    <template x-for="day in calendar.days">
                        <div :class="['cal-day', day.isToday ? 'cal-today' : '', day.hasLog ? 'cal-active' : '']" x-text="day.num"></div>
                    </template>
                </div>
            </div>

            <!-- Log List -->
            <div>
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Recent Sessions</h3>
                <div class="space-y-3">
                    <template x-for="(log, idx) in history.slice().reverse().slice(0, 10)">
                        <div class="glass p-4 rounded-2xl flex flex-col gap-2 active:bg-white/5 transition cursor-pointer">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="text-sm font-bold text-white" x-text="log.title"></div>
                                    <div class="text-xs text-slate-500 mt-0.5" x-text="log.date"></div>
                                </div>
                                <div class="text-right">
                                    <div x-show="log.pr" class="inline-block px-1.5 py-0.5 bg-yellow-500/10 border border-yellow-500/20 text-yellow-500 text-[9px] font-bold rounded mb-1">TM INCREASE</div>
                                    <div class="text-xs font-bold text-slate-300">TM +<span x-text="log.increase || 0"></span></div>
                                </div>
                            </div>
                            <!-- Show Notes if present -->
                            <div x-show="log.notes" class="text-[11px] text-slate-400 bg-black/30 p-2 rounded-lg border border-white/5 italic">
                                "<span x-text="log.notes"></span>"
                            </div>
                        </div>
                    </template>
                    <div x-show="history.length === 0" class="text-center py-8 text-slate-500 text-sm">No workouts logged yet.</div>
                </div>
            </div>
            
            <!-- Data Management -->
            <div class="pt-8 pb-4">
                 <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Data</h3>
                 <div class="flex gap-3">
                     <button @click="exportData()" class="flex-1 bg-[#222] text-xs font-bold py-3 rounded-xl text-white border border-white/10 hover:bg-[#2a2a2a] transition">Export</button>
                     <button @click="triggerImport()" class="flex-1 bg-[#222] text-xs font-bold py-3 rounded-xl text-white border border-white/10 hover:bg-[#2a2a2a] transition">Import</button>
                     <input type="file" id="importFile" class="hidden" @change="importData($event)">
                     <button @click="resetAll()" class="flex-1 bg-red-900/10 text-xs font-bold py-3 rounded-xl text-red-400 border border-red-500/20 hover:bg-red-900/20 transition">Reset</button>
                 </div>
            </div>
        </div>
    </div>

    <!-- ================= WORKOUT SESSION ================= -->
    <div x-show="view === 'workout'" class="fixed inset-0 z-50 bg-black overflow-y-auto" x-cloak>
        <!-- Sticky Header -->
        <div class="sticky top-0 bg-black/90 backdrop-blur-md border-b border-white/5 p-4 flex justify-between items-center z-30">
            <button @click="view='dashboard'; stopTimer()" class="text-slate-400 text-sm font-bold">Cancel</button>
            <div class="text-center">
                <div class="text-white font-bold text-sm" x-text="activeSession.title"></div>
                <div class="text-[10px] text-indigo-500 font-bold uppercase tracking-widest">In Progress</div>
            </div>
            <button @click="finishSession()" class="bg-indigo-600 px-4 py-1.5 rounded-full text-xs font-bold text-white shadow-lg shadow-indigo-600/20">Finish</button>
        </div>

        <!-- Dynamic Timer Island -->
        <div x-show="timer.active" x-transition class="sticky top-16 z-20 mx-auto max-w-[220px] bg-[#1A1A1E] border border-white/10 rounded-full shadow-2xl flex items-center justify-between p-1 pr-4 overflow-hidden mt-2">
            <div class="absolute inset-0 bg-indigo-600/20 origin-left transition-transform duration-1000 linear" :style="`transform: scaleX(${timer.rem / timer.total})`"></div>
            <div class="flex items-center gap-2 relative z-10">
                <button @click="adjustTimer(-30)" class="w-8 h-8 flex items-center justify-center hover:bg-white/5 rounded-full text-slate-400">-</button>
                <span class="text-white font-bold mono w-12 text-center" x-text="formatTime(timer.rem)"></span>
                <button @click="adjustTimer(30)" class="w-8 h-8 flex items-center justify-center hover:bg-white/5 rounded-full text-slate-400">+</button>
            </div>
            <button @click="stopTimer()" class="relative z-10 text-[10px] font-bold text-red-400 hover:text-red-300">STOP</button>
        </div>

        <div class="p-4 space-y-8 pb-40">
            <!-- Smart Warmups -->
            <div class="bg-indigo-900/10 border border-indigo-500/20 rounded-2xl overflow-hidden">
                <button @click="showWarmups = !showWarmups" class="w-full flex justify-between items-center p-3">
                    <span class="text-xs font-bold text-indigo-400 uppercase tracking-widest flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/></svg>
                        Warm-up Sets
                    </span>
                    <svg class="w-4 h-4 text-indigo-400 transition-transform" :class="showWarmups?'rotate-180':''" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div x-show="showWarmups" x-collapse class="px-3 pb-3 grid grid-cols-4 gap-2">
                    <template x-for="wu in generateWarmups()">
                        <div class="bg-black/40 rounded-lg p-2 text-center border border-white/5">
                            <div class="text-sm font-bold text-white mono" x-text="wu.weight"></div>
                            <div class="text-[9px] text-slate-400">x<span x-text="wu.reps"></span></div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- T1 -->
            <div>
                <h3 class="text-2xl font-extrabold text-white mb-4 flex items-center justify-between">
                    <span x-text="activeSession.t1.name"></span>
                    <span class="text-[10px] px-2 py-1 rounded bg-white/5 border border-white/10 text-slate-400 uppercase tracking-widest font-bold">Tier 1</span>
                </h3>
                <div class="space-y-2">
                    <template x-for="(set, i) in activeSession.t1.sets">
                        <div class="glass p-3 rounded-xl flex items-center justify-between transition-all" :class="set.completed ? 'border-green-500/30 bg-green-500/5' : ''">
                            <div class="flex items-center gap-3">
                                <span class="text-xs font-bold text-slate-600 w-4" x-text="i+1"></span>
                                <div @click="openPlateCalc(set.weight)">
                                    <div class="text-xl font-bold text-white mono"><span x-text="set.weight"></span><span class="text-xs text-slate-500 ml-1 font-sans">lbs</span></div>
                                    <div class="text-[10px] font-bold" :class="set.amrap ? 'text-yellow-500' : 'text-slate-500'" x-text="set.amrap ? '1+ AMRAP' : set.reps + ' reps'"></div>
                                </div>
                            </div>
                            
                            <!-- Enhanced AMRAP Input with RPE -->
                            <template x-if="set.amrap">
                                <div class="flex items-center gap-2">
                                    <div class="flex flex-col items-end">
                                        <label class="text-[8px] text-slate-500 font-bold uppercase">Reps</label>
                                        <input type="number" x-model="set.performed" @input="completeSet(set, true)" class="w-12 h-8 bg-black border border-white/20 rounded-lg text-center text-white font-bold focus:border-yellow-500 outline-none mono">
                                    </div>
                                    <div class="flex flex-col items-end">
                                        <label class="text-[8px] text-slate-500 font-bold uppercase">RPE</label>
                                        <select x-model="set.rpe" class="w-12 h-8 bg-black border border-white/20 rounded-lg text-center text-xs text-white font-bold focus:border-indigo-500 outline-none appearance-none">
                                            <option value="">-</option>
                                            <option value="6">6</option>
                                            <option value="7">7</option>
                                            <option value="8">8</option>
                                            <option value="9">9</option>
                                            <option value="10">10</option>
                                        </select>
                                    </div>
                                </div>
                            </template>
                            <template x-if="!set.amrap">
                                <button @click="completeSet(set)" class="w-10 h-10 rounded-lg border flex items-center justify-center transition" :class="set.completed ? 'bg-green-500 border-green-500 text-black shadow-[0_0_15px_rgba(34,197,94,0.4)]' : 'border-white/10 hover:border-white/30'">
                                    <svg x-show="set.completed" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
                                </button>
                            </template>
                        </div>
                    </template>
                </div>
            </div>

            <!-- T2 -->
            <div>
                <h3 class="text-lg font-bold text-slate-300 mb-3 flex items-center justify-between">
                    <span x-text="activeSession.t2.name"></span>
                    <span class="text-[10px] px-2 py-1 rounded bg-white/5 border border-white/10 text-slate-400 uppercase tracking-widest font-bold">Tier 2</span>
                </h3>
                <div class="grid grid-cols-4 gap-2">
                    <template x-for="set in activeSession.t2.sets">
                        <button @click="completeSet(set)" class="glass aspect-square rounded-xl flex flex-col items-center justify-center relative overflow-hidden active:scale-95 transition duration-200"
                            :class="set.completed ? 'border-indigo-500/50 bg-indigo-500/10 shadow-[0_0_10px_rgba(99,102,241,0.2)]' : ''">
                            <span class="text-sm font-bold text-white mono" x-text="set.weight"></span>
                            <span class="text-[9px] text-slate-500 mt-1">x<span x-text="set.reps"></span></span>
                        </button>
                    </template>
                </div>
            </div>

            <!-- Acc -->
            <div class="pt-6 border-t border-white/5">
                <div class="space-y-4">
                    <template x-for="acc in activeSession.accessories">
                        <div class="glass p-4 rounded-xl">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-bold text-white" x-text="acc.name"></span>
                                <span class="text-[10px] bg-white/10 px-2 py-1 rounded text-slate-300" x-text="acc.reps"></span>
                            </div>
                            <div class="flex gap-2">
                                <template x-for="n in acc.sets">
                                    <button @click="toggleAcc(acc.name, n)" class="h-8 flex-1 rounded border text-xs font-bold transition"
                                        :class="isAccDone(acc.name, n) ? 'bg-slate-200 text-black border-slate-200 shadow-sm' : 'border-white/10 text-slate-500 hover:bg-white/5'">
                                        <span x-show="!isAccDone(acc.name, n)" x-text="n"></span>
                                        <span x-show="isAccDone(acc.name, n)">âœ“</span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Session Notes -->
            <div class="pt-4">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest pl-1">Session Notes</label>
                <textarea x-model="activeSession.notes" class="w-full h-24 bg-[#121214] border border-white/10 rounded-xl p-3 text-sm text-white mt-2 focus:border-indigo-500 outline-none resize-none" placeholder="How did it feel? Any pain?"></textarea>
            </div>
        </div>
    </div>

    <!-- ================= PLATE DRAWER ================= -->
    <div x-show="plateCalc.open" class="fixed inset-0 z-[60]" x-cloak>
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" @click="plateCalc.open = false" x-transition.opacity></div>
        <div class="absolute bottom-0 inset-x-0 bg-[#1A1A1E] rounded-t-3xl p-8 border-t border-white/10" 
             x-transition:enter="transition ease-out duration-300" x-transition:enter-start="translate-y-full" x-transition:enter-end="translate-y-0"
             x-transition:leave="transition ease-in duration-200" x-transition:leave-start="translate-y-0" x-transition:leave-end="translate-y-full">
            
            <div class="text-center mb-8">
                <div class="text-6xl font-extrabold text-white mono tracking-tighter" x-text="plateCalc.weight"></div>
                <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mt-2">Target Load</div>
            </div>
            
            <div class="flex justify-center items-center gap-1 mb-10 scale-90 sm:scale-100">
                <div class="h-20 w-4 bg-slate-700 rounded-sm border border-slate-600"></div>
                <template x-for="p in plateCalc.plates">
                    <div class="h-20 w-8 rounded flex items-center justify-center text-xs font-bold text-black shadow-lg"
                         :class="getPlateColor(p)" x-text="p"></div>
                </template>
            </div>
            
            <button @click="plateCalc.open = false" class="w-full bg-[#333] text-white font-bold py-4 rounded-xl hover:bg-[#444] transition">Close</button>
        </div>
    </div>

    <!-- ================= NAV ================= -->
    <nav x-show="view !== 'setup' && view !== 'workout'" class="fixed bottom-0 w-full nav-glass pb-safe pt-2 px-6 z-40 flex justify-between items-center h-20">
        <button @click="view='dashboard'" class="flex-1 flex flex-col items-center gap-1 transition" :class="view==='dashboard'?'text-indigo-400':'text-slate-500'">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
            <span class="text-[10px] font-bold">Train</span>
        </button>
        <button @click="view='calendar'" class="flex-1 flex flex-col items-center gap-1 transition" :class="view==='calendar'?'text-indigo-400':'text-slate-500'">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            <span class="text-[10px] font-bold">History</span>
        </button>
    </nav>

    <script>
        // Audio Context for beeps
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = 800;
            gain.gain.value = 0.1;
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
            osc.stop(audioCtx.currentTime + 0.5);
        }

        function app() {
            return {
                view: 'dashboard',
                setup: { Bench:'', Squat:'', Deadlift:'', OHP:'' },
                tms: { Bench:0, Squat:0, Deadlift:0, OHP:0 },
                currentDayIndex: 0,
                currentWeek: 1,
                streak: 0,
                history: [],
                chartLift: 'Bench',
                
                // Session
                activeSession: { title:'', t1:{}, t2:{}, accessories:[], completedAcc:{}, notes:'' },
                showWarmups: false,
                timer: { active:false, total:0, rem:0, interval:null },
                plateCalc: { open:false, weight:0, plates:[] },
                
                // Calendar State
                calendar: { monthName: '', days: [], offset: 0 },

                init() {
                    const data = JSON.parse(localStorage.getItem('nsuns_ultimate'));
                    if(data) {
                        this.tms = data.tms;
                        this.currentDayIndex = data.currentDayIndex || 0;
                        this.currentWeek = data.currentWeek || 1;
                        this.history = data.history || [];
                        this.streak = data.streak || 0;
                        this.$nextTick(() => { this.renderChart(); this.buildCalendar(); });
                    } else {
                        this.view = 'setup';
                    }
                },

                finishSetup() {
                    if(!this.setup.Bench) return;
                    for(let k in this.setup) this.tms[k] = this.round(this.setup[k] * 0.9);
                    this.save();
                    this.view = 'dashboard';
                    this.$nextTick(() => { this.renderChart(); this.buildCalendar(); });
                },

                getWorkout() {
                    const w = [
                        { t:'Volume Bench', f:'Upper Pump', t1:'Bench', t2:'OHP' },
                        { t:'Heavy Squat', f:'Lower Strength', t1:'Squat', t2:'Deadlift' },
                        { t:'Heavy OHP', f:'Shoulders', t1:'OHP', t2:'Bench' },
                        { t:'Heavy Deadlift', f:'Posterior Chain', t1:'Deadlift', t2:'Squat' },
                        { t:'Heavy Bench', f:'Max Press', t1:'Bench', t2:'Bench' }
                    ];
                    return w[this.currentDayIndex];
                },

                startSession() {
                    const d = this.getWorkout();
                    this.activeSession.title = d.t;
                    this.activeSession.completedAcc = {};
                    this.activeSession.notes = '';
                    this.showWarmups = false;
                    
                    const sets = { vol:[8,6,4,4,4,5,6,7,8], hvy:[5,3,1,3,3,3,5,5,5], dl:[5,3,1,3,3,3,3,3,3], t2:[6,5,3,5,7,4,6,8] };
                    const pct = { vol:[.65,.75,.85,.85,.85,.80,.75,.70,.65], hvy:[.75,.85,.95,.90,.85,.80,.75,.70,.65], t2:[.50,.60,.70,.70,.70,.70,.70,.70] };
                    
                    let s = sets.hvy, p = pct.hvy;
                    if(this.currentDayIndex===0) { s = sets.vol; p = pct.vol; }
                    if(this.currentDayIndex===3) { s = sets.dl; }

                    this.activeSession.t1 = {
                        name: d.t1,
                        sets: s.map((r,i) => {
                            let amrap = (this.currentDayIndex!==0 && i===2) || (this.currentDayIndex===0 && i===8) || (i===8 && this.currentDayIndex!==3);
                            if(this.currentDayIndex===3 && i===8) amrap=true;
                            return { weight: this.round(this.tms[d.t1] * p[i]), reps: r, amrap, completed: false, performed: amrap?null:r, rpe: '' };
                        })
                    };

                    let t2tm = this.tms[d.t2];
                    if(d.t.includes('Squat') && d.t2==='Deadlift') t2tm = this.tms.Deadlift; // Sumo
                    if(d.t.includes('OHP') && d.t2==='Bench') t2tm = this.tms.Bench; // Incline

                    this.activeSession.t2 = {
                        name: d.t2 + " Var",
                        sets: sets.t2.map((r,i) => ({ weight: this.round(t2tm * pct.t2[i]), reps: r, completed: false }))
                    };

                    const acc = [
                        [{name:'Row',sets:4,reps:10},{name:'Dips',sets:3,reps:12}],
                        [{name:'Leg Press',sets:4,reps:12},{name:'Curls',sets:4,reps:15}],
                        [{name:'Pullups',sets:4,reps:8},{name:'Face Pull',sets:4,reps:15}],
                        [{name:'RDL',sets:3,reps:10},{name:'Abs',sets:4,reps:15}],
                        [{name:'Tri Ext',sets:4,reps:12},{name:'Curls',sets:4,reps:12}]
                    ];
                    this.activeSession.accessories = acc[this.currentDayIndex];
                    this.view = 'workout';
                },

                generateWarmups() {
                    // Logic: Empty bar, then 40%, 60%, 80% of first working set
                    const workWeight = this.activeSession.t1.sets[0].weight;
                    const wu = [
                        { weight: 45, reps: 10 },
                        { weight: this.round(workWeight * 0.4), reps: 5 },
                        { weight: this.round(workWeight * 0.6), reps: 3 },
                        { weight: this.round(workWeight * 0.8), reps: 2 }
                    ];
                    return wu.filter((w, i) => i === 0 || w.weight > 45); // Dedupe if light
                },

                completeSet(set, isInput) {
                    if(!isInput) set.completed = !set.completed;
                    else if(set.performed) set.completed = true;
                    if(set.completed) this.startTimer(this.activeSession.t1.sets.includes(set) ? 120 : 90);
                },

                finishSession() {
                    const prSet = this.activeSession.t1.sets.find(s => s.amrap && s.weight === Math.max(...this.activeSession.t1.sets.map(x=>x.weight)));
                    let increase = 0;
                    let est1rm = 0;

                    if(prSet && prSet.performed) {
                        const r = parseInt(prSet.performed);
                        if(r>1) increase=5; if(r>3) increase=10; if(r>5) increase=15;
                        // Epley formula for 1RM
                        est1rm = Math.round(prSet.weight * (1 + r/30));
                    }

                    if(increase>0) {
                        this.tms[this.activeSession.t1.name] += increase;
                        confetti({particleCount:100, spread:70, origin:{y:0.6}, colors: ['#6366f1', '#ffffff']});
                    }

                    this.history.push({
                        date: new Date().toLocaleDateString('en-US'),
                        title: this.activeSession.title,
                        increase: increase,
                        pr: increase > 0,
                        notes: this.activeSession.notes,
                        details: { 
                            t1: this.activeSession.t1.name, 
                            weight: prSet ? prSet.weight : 0,
                            reps: prSet ? prSet.performed : 0,
                            est1rm: est1rm
                        }
                    });

                    this.currentDayIndex++;
                    if(this.currentDayIndex > 4) { this.currentDayIndex=0; this.currentWeek++; }
                    this.streak++;
                    
                    this.save();
                    this.stopTimer();
                    this.view = 'dashboard';
                    this.buildCalendar();
                    this.renderChart();
                },

                getBest1RM(lift) {
                    const liftHist = this.history.filter(h => h.details && h.details.t1 === lift && h.details.est1rm);
                    if(!liftHist.length) return this.round(this.tms[lift] / 0.9); // Fallback to TM calc
                    return Math.max(...liftHist.map(h => h.details.est1rm));
                },

                // UTILS
                round(n) { return 5 * Math.round(n / 5); },
                
                // TIMER
                startTimer(s) {
                    this.stopTimer(); this.timer.active=true; this.timer.total=s; this.timer.rem=s;
                    this.timer.interval = setInterval(() => {
                        this.timer.rem--; 
                        if(this.timer.rem<=0) { 
                            this.stopTimer(); 
                            playBeep(); 
                            if(navigator.vibrate) navigator.vibrate([200,100,200]); 
                        }
                    }, 1000);
                },
                stopTimer() { this.timer.active=false; clearInterval(this.timer.interval); },
                adjustTimer(s) { this.timer.rem += s; },
                formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; },

                // CALENDAR
                buildCalendar() {
                    const now = new Date();
                    now.setMonth(now.getMonth() + this.calendar.offset);
                    this.calendar.monthName = now.toLocaleString('default', {month:'long', year:'numeric'});
                    
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
                    const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
                    
                    this.calendar.days = [];
                    for(let i=0; i<firstDay; i++) this.calendar.days.push({num:''});
                    
                    for(let i=1; i<=daysInMonth; i++) {
                        const dStr = new Date(now.getFullYear(), now.getMonth(), i).toLocaleDateString('en-US');
                        const hasLog = this.history.some(h => h.date === dStr);
                        const isToday = new Date().toLocaleDateString('en-US') === dStr;
                        this.calendar.days.push({ num:i, isToday, hasLog });
                    }
                },
                changeMonth(d) { this.calendar.offset += d; this.buildCalendar(); },

                // PLATE MATH
                openPlateCalc(w) {
                    this.plateCalc.weight=w; this.plateCalc.plates=[]; let r=(w-45)/2;
                    [45,25,10,5,2.5].forEach(p=>{ while(r>=p) { this.plateCalc.plates.push(p); r-=p; } });
                    this.plateCalc.open=true;
                },
                getPlateColor(p) {
                    if(p==45) return 'bg-blue-600 text-white';
                    if(p==25) return 'bg-yellow-500 text-black';
                    if(p==10) return 'bg-green-500 text-black';
                    return 'bg-white text-black';
                },

                // ACC
                toggleAcc(n,i) { const k=`${n}-${i}`; this.activeSession.completedAcc[k]=!this.activeSession.completedAcc[k]; },
                isAccDone(n,i) { return !!this.activeSession.completedAcc[`${n}-${i}`]; },

                // DATA
                save() { localStorage.setItem('nsuns_ultimate', JSON.stringify({tms:this.tms, currentDayIndex:this.currentDayIndex, currentWeek:this.currentWeek, streak:this.streak, history:this.history})); },
                exportData() {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(localStorage.getItem('nsuns_ultimate')));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href",     dataStr);
                    downloadAnchorNode.setAttribute("download", "nsuns_backup.json");
                    document.body.appendChild(downloadAnchorNode); 
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                },
                triggerImport() { document.getElementById('importFile').click(); },
                importData(e) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            // Fix: Handle potentially single or double stringified JSON
                            let raw = event.target.result;
                            let data;
                            try { data = JSON.parse(JSON.parse(raw)); } catch(e) { data = JSON.parse(raw); }
                            
                            if(data && data.tms) {
                                localStorage.setItem('nsuns_ultimate', JSON.stringify(data));
                                location.reload();
                            } else {
                                alert("Invalid file format");
                            }
                        } catch(err) {
                            alert("Error importing data");
                        }
                    };
                    reader.readAsText(e.target.files[0]);
                },
                resetAll() { if(confirm("Delete all progress?")) { localStorage.removeItem('nsuns_ultimate'); location.reload(); } },

                renderChart() {
                    const ctx = document.getElementById('mainChart');
                    if(!ctx) return;
                    
                    const lift = this.chartLift;
                    const liftData = this.history
                        .filter(h => h.details && h.details.t1 === lift)
                        .map(h => ({ x: h.date, y: h.details.est1rm || h.details.weight }));

                    if(window.myChart) window.myChart.destroy();
                    
                    window.myChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: liftData.length ? liftData.map(d => d.x) : ['Start'],
                            datasets: [{
                                label: 'Est. 1RM',
                                data: liftData.length ? liftData.map(d => d.y) : [this.tms[lift]],
                                borderColor: '#6366f1', borderWidth: 2, tension: 0.3, pointBackgroundColor: '#fff',
                                backgroundColor: (ctx) => {
                                    const grad = ctx.chart.ctx.createLinearGradient(0,0,0,160);
                                    grad.addColorStop(0, 'rgba(99,102,241,0.5)');
                                    grad.addColorStop(1, 'rgba(99,102,241,0.0)');
                                    return grad;
                                },
                                fill: true
                            }]
                        },
                        options: { 
                            responsive:true, 
                            maintainAspectRatio:false, 
                            plugins:{legend:{display:false}}, 
                            scales:{
                                x:{display:false}, 
                                y:{grid:{color:'rgba(255,255,255,0.05)'}, ticks:{color:'#666'}}
                            } 
                        }
                    });
                }
            }
        }
    </script>
</body>
</html>